// Prisma Schema for Trading Bot Historical Data
// Database: PostgreSQL (or SQLite for local dev)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Trading History - Her bir trade
model Trade {
  id            String   @id @default(cuid())
  symbol        String
  side          String   // LONG, SHORT
  entryPrice    Float
  exitPrice     Float?
  quantity      Float
  leverage      Int
  pnl           Float?
  pnlPercent    Float?
  status        String   // OPEN, CLOSED, LIQUIDATED

  // Timestamps
  entryTime     DateTime @default(now())
  exitTime      DateTime?

  // Risk Management
  stopLoss      Float?
  takeProfit    Float?

  // Metadata
  strategyId    String?
  botId         String

  // Relations
  bot           Bot      @relation(fields: [botId], references: [id])

  @@index([symbol])
  @@index([botId])
  @@index([entryTime])
}

// Bot Configuration & Status
model Bot {
  id              String   @id @default(cuid())
  name            String
  symbol          String
  leverage        Int
  status          String   // ACTIVE, PAUSED, STOPPED

  // Config
  maxPositionSize Float
  stopLossPercent Float
  takeProfitPercent Float
  maxDailyLoss    Float

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  trades          Trade[]
  metrics         DailyMetrics[]
  alerts          Alert[]

  @@index([symbol])
  @@index([status])
}

// Daily Metrics Snapshot
model DailyMetrics {
  id              String   @id @default(cuid())
  botId           String
  date            DateTime @default(now())

  // Performance
  totalTrades     Int
  winningTrades   Int
  losingTrades    Int
  winRate         Float
  totalPnL        Float
  dailyPnL        Float

  // Risk
  sharpeRatio     Float
  maxDrawdown     Float
  currentDrawdown Float

  // Volume
  totalVolume     Float
  avgTradeSize    Float

  // Relations
  bot             Bot      @relation(fields: [botId], references: [id])

  @@unique([botId, date])
  @@index([botId])
  @@index([date])
}

// Alerts History
model Alert {
  id          String   @id @default(cuid())
  botId       String
  type        String   // SUCCESS, WARNING, ERROR, INFO
  severity    String   // LOW, MEDIUM, HIGH, CRITICAL
  title       String
  message     String

  // Metadata
  data        Json?
  acknowledged Boolean  @default(false)

  // Timestamps
  createdAt   DateTime @default(now())

  // Relations
  bot         Bot      @relation(fields: [botId], references: [id])

  @@index([botId])
  @@index([type])
  @@index([severity])
  @@index([createdAt])
}

// Performance Metrics (Time Series)
model PerformanceMetric {
  id              String   @id @default(cuid())
  botId           String
  timestamp       DateTime @default(now())

  // Snapshot data
  totalPnL        Float
  openPositions   Int
  winRate         Float
  sharpeRatio     Float
  drawdown        Float

  @@index([botId])
  @@index([timestamp])
}

// Market Data (Optional - for backtesting)
model MarketData {
  id        String   @id @default(cuid())
  symbol    String
  timestamp DateTime

  // OHLCV
  open      Float
  high      Float
  low       Float
  close     Float
  volume    Float

  // Timeframe
  timeframe String   // 1m, 5m, 15m, 1h, 4h, 1d

  @@unique([symbol, timestamp, timeframe])
  @@index([symbol])
  @@index([timestamp])
}
