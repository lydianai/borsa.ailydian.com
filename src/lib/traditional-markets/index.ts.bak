/**
 * < TRADITIONAL MARKETS - UNIFIED SERVICE
 * Aggregates all traditional market data - LIVE DATA ONLY
 *
 * Combines:
 * - Precious Metals (Gold, Silver, Palladium, Copper)
 * - Forex (10 major currencies vs TRY)
 * - DXY (US Dollar Index)
 */

import {
  getPreciousMetalsData,
  clearPreciousMetalsCache,
  type PreciousMetalsData,
  type GoldPrice,
  type PreciousMetalPrice,
} from './precious-metals-adapter';

import {
  getForexData,
  getCurrencyRate,
  clearForexCache,
  type ForexData,
  type ForexRate,
} from './forex-adapter';

import {
  getDXYData,
  clearDXYCache,
  getDXYTrend,
  type DXYData,
} from './dxy-adapter';

// ============================================================================
// RE-EXPORTS
// ============================================================================

export type {
  PreciousMetalsData,
  GoldPrice,
  PreciousMetalPrice,
  ForexData,
  ForexRate,
  DXYData,
};

export {
  // Precious Metals
  getPreciousMetalsData,
  clearPreciousMetalsCache,

  // Forex
  getForexData,
  getCurrencyRate,
  clearForexCache,

  // DXY
  getDXYData,
  clearDXYCache,
  getDXYTrend,
};

// ============================================================================
// UNIFIED DATA TYPE
// ============================================================================

export interface TraditionalMarketsData {
  metals: PreciousMetalsData;
  forex: ForexData;
  dxy: DXYData;
  timestamp: Date;
  summary: {
    totalAssets: number;
    categories: {
      metals: number;
      currencies: number;
      indices: number;
    };
  };
}

// ============================================================================
// UNIFIED SERVICE
// ============================================================================

/**
 * Get all traditional markets data in one call
 * REAL-TIME DATA ONLY - NO MOCK DATA
 */
export async function getAllTraditionalMarketsData(
  forceRefresh: boolean = false
): Promise<TraditionalMarketsData> {
  console.log('[TraditionalMarkets] Fetching all data...');

  try {
    // Fetch all data in parallel for performance
    const [metals, forex, dxy] = await Promise.all([
      getPreciousMetalsData(forceRefresh),
      getForexData(forceRefresh),
      getDXYData(forceRefresh),
    ]);

    const data: TraditionalMarketsData = {
      metals,
      forex,
      dxy,
      timestamp: new Date(),
      summary: {
        totalAssets: 4 + forex.rates.length + 1, // 4 metals + N currencies + 1 DXY
        categories: {
          metals: 4, // Gold, Silver, Palladium, Copper
          currencies: forex.rates.length,
          indices: 1, // DXY
        },
      },
    };

    console.log('[TraditionalMarkets] All data fetched successfully');
    return data;
  } catch (error: any) {
    console.error('[TraditionalMarkets] Failed to fetch all data:', error);
    throw new Error(`Failed to fetch traditional markets data: ${error.message}`);
  }
}

/**
 * Clear all traditional markets caches
 */
export function clearAllTraditionalMarketsCache(): void {
  clearPreciousMetalsCache();
  clearForexCache();
  clearDXYCache();
  console.log('[TraditionalMarkets] All caches cleared');
}

/**
 * Get specific asset data by symbol
 */
export async function getAssetBySymbol(
  symbol: string,
  forceRefresh: boolean = false
): Promise<GoldPrice | PreciousMetalPrice | ForexRate | DXYData | null> {
  // Check if it's a metal
  if (['XAU', 'XAG', 'XPD', 'XCU'].includes(symbol)) {
    const metals = await getPreciousMetalsData(forceRefresh);
    switch (symbol) {
      case 'XAU':
        return metals.gold;
      case 'XAG':
        return metals.silver;
      case 'XPD':
        return metals.palladium;
      case 'XCU':
        return metals.copper;
    }
  }

  // Check if it's a currency
  if (['USD', 'EUR', 'GBP', 'JPY', 'CHF', 'CAD', 'AUD', 'CNY', 'RUB', 'SAR'].includes(symbol)) {
    return await getCurrencyRate(symbol, forceRefresh);
  }

  // Check if it's DXY
  if (symbol === 'DXY') {
    return await getDXYData(forceRefresh);
  }

  return null;
}

/**
 * Get market overview summary
 */
export async function getMarketOverview(
  forceRefresh: boolean = false
): Promise<{
  trending: Array<{ symbol: string; name: string; change: number }>;
  strongest: { symbol: string; name: string; change: number } | null;
  weakest: { symbol: string; name: string; change: number } | null;
  dxyTrend: 'bullish' | 'bearish' | 'neutral';
}> {
  const data = await getAllTraditionalMarketsData(forceRefresh);

  // Collect all assets with changes
  const allAssets: Array<{ symbol: string; name: string; change: number }> = [
    {
      symbol: data.metals.gold.symbol,
      name: data.metals.gold.name,
      change: data.metals.gold.change24h,
    },
    {
      symbol: data.metals.silver.symbol,
      name: data.metals.silver.name,
      change: data.metals.silver.change24h,
    },
    {
      symbol: data.metals.palladium.symbol,
      name: data.metals.palladium.name,
      change: data.metals.palladium.change24h,
    },
    {
      symbol: data.metals.copper.symbol,
      name: data.metals.copper.name,
      change: data.metals.copper.change24h,
    },
    ...data.forex.rates.map((rate) => ({
      symbol: rate.symbol,
      name: rate.name,
      change: rate.change24h,
    })),
    {
      symbol: data.dxy.symbol,
      name: data.dxy.name,
      change: data.dxy.changePercent,
    },
  ];

  // Sort by absolute change
  const sorted = [...allAssets].sort((a, b) => Math.abs(b.change) - Math.abs(a.change));

  // Get top movers
  const trending = sorted.slice(0, 5);

  // Get strongest/weakest
  const byChange = [...allAssets].sort((a, b) => b.change - a.change);
  const strongest = byChange[0] || null;
  const weakest = byChange[byChange.length - 1] || null;

  return {
    trending,
    strongest,
    weakest,
    dxyTrend: getDXYTrend(data.dxy),
  };
}
