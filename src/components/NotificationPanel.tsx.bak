'use client';

/**
 * ENHANCED REAL-TIME NOTIFICATION PANEL
 * - Dynamic notifications (her bildirim farklÄ±)
 * - Clear all button (Temizle)
 * - Compact size (KÃ¼Ã§Ã¼k)
 * - Sort by confidence % (En yÃ¼ksek yÃ¼zde Ã¼stte)
 * - Auto-remove low confidence (YÃ¼zde dÃ¼ÅŸerse kaldÄ±r)
 */

import { useState, useEffect, useRef } from 'react';
import { Icons } from './Icons';
import * as PushClient from '@/lib/push/push-client';

interface Notification {
  id: string;
  type: 'BUY' | 'SELL' | 'ALERT' | 'INFO';
  symbol: string;
  message: string;
  timestamp: Date;
  read: boolean;
  confidence: number;
  changePercent?: number; // YÃ¼zde deÄŸiÅŸim
}

const MIN_CONFIDENCE_THRESHOLD = 70; // Bu deÄŸerin altÄ±ndakiler otomatik kaldÄ±rÄ±lÄ±r

interface NotificationPanelProps {
  isOpen?: boolean;
  onClose?: () => void;
}

export function NotificationPanel({ isOpen = false, onClose }: NotificationPanelProps = {}) {
  const [notifications, setNotifications] = useState<Notification[]>([]);
  const [unreadCount, setUnreadCount] = useState(0);
  const [lastFetchTime, setLastFetchTime] = useState(0);
  const panelRef = useRef<HTMLDivElement>(null);

  // Push Notification States
  const [pushSupported, setPushSupported] = useState(false);
  const [pushSubscribed, setPushSubscribed] = useState(false);
  const [pushLoading, setPushLoading] = useState(false);
  const [pushError, setPushError] = useState<string | null>(null);

  // Fetch real-time notifications with intelligent deduplication
  const fetchNotifications = async () => {
    try {
      const now = Date.now();

      // Get real signals from backend
      const [signalsRes, aiSignalsRes] = await Promise.all([
        fetch('/api/signals', { cache: 'no-store' }),
        fetch('/api/ai-signals', { cache: 'no-store' })
      ]);

      const signals = await signalsRes.json();
      const aiSignals = await aiSignalsRes.json();

      const newNotifications: Notification[] = [];
      const seenSymbols = new Set<string>(); // Deduplicate

      // Process AI signals FIRST (Ã¶ncelik AI'da)
      if (aiSignals.success && aiSignals.data.signals) {
        aiSignals.data.signals
          .filter((s: any) =>
            s.confidence >= MIN_CONFIDENCE_THRESHOLD &&
            s.type === 'BUY' &&
            !seenSymbols.has(s.symbol)
          )
          .forEach((signal: any) => {
            seenSymbols.add(signal.symbol);

            // AL sinyalleri iÃ§in Ã¶zel mesaj
            const confidenceEmoji = signal.confidence >= 90 ? 'ðŸ”¥' : signal.confidence >= 80 ? 'âš¡' : 'ðŸ’Ž';

            newNotifications.push({
              id: `${signal.id}-${now}`,
              type: signal.type,
              symbol: signal.symbol,
              message: `${confidenceEmoji} ${signal.symbol}: GÃ¼Ã§lÃ¼ AL sinyali - %${signal.confidence} gÃ¼ven`,
              timestamp: new Date(signal.timestamp),
              read: false,
              confidence: signal.confidence,
              changePercent: signal.changePercent24h
            });
          });
      }

      // Process trading signals
      if (signals.success && signals.data.signals) {
        signals.data.signals
          .filter((s: any) =>
            s.confidence >= MIN_CONFIDENCE_THRESHOLD &&
            s.type === 'BUY' &&
            !seenSymbols.has(s.symbol)
          )
          .forEach((signal: any) => {
            seenSymbols.add(signal.symbol);

            newNotifications.push({
              id: `${signal.id}-${now}`,
              type: signal.type,
              symbol: signal.symbol,
              message: `${signal.symbol}: ${signal.strategy} - %${signal.confidence}`,
              timestamp: new Date(signal.timestamp),
              read: false,
              confidence: signal.confidence
            });
          });
      }

      // SIRALA: En yÃ¼ksek confidence Ã¼stte, KALICI
      newNotifications.sort((a, b) => {
        // Ã–nce confidence'e gÃ¶re sÄ±rala (en yÃ¼ksek en Ã¼stte)
        if (b.confidence !== a.confidence) {
          return b.confidence - a.confidence;
        }
        // Confidence eÅŸitse timestamp'e gÃ¶re (en yeni en Ã¼stte)
        return b.timestamp.getTime() - a.timestamp.getTime();
      });

      // Sadece confidence threshold Ã¼zerinde olanlarÄ± tut (otomatik temizleme)
      const filteredNotifications = newNotifications.filter(
        n => n.confidence >= MIN_CONFIDENCE_THRESHOLD
      );

      // Maksimum 15 bildirim gÃ¶ster
      const limitedNotifications = filteredNotifications.slice(0, 15);

      setNotifications(limitedNotifications);
      setUnreadCount(limitedNotifications.filter(n => !n.read).length);
      setLastFetchTime(now);
    } catch (error) {
      console.error('Notification fetch error:', error);
    }
  };

  useEffect(() => {
    fetchNotifications();
    const interval = setInterval(fetchNotifications, 5000); // Update every 5s (daha sÄ±k)
    return () => clearInterval(interval);
  }, []);

  // Push Notification Status Check (on mount)
  useEffect(() => {
    async function checkPushStatus() {
      const supported = PushClient.isPushSupported();
      setPushSupported(supported);

      if (supported) {
        try {
          const state = await PushClient.getSubscriptionState();
          setPushSubscribed(state.subscribed);
        } catch (error: any) {
          console.error('[NotificationPanel] Push status check failed:', error);
        }
      }
    }
    checkPushStatus();
  }, []);

  // Close on outside click
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (panelRef.current && !panelRef.current.contains(event.target as Node)) {
        onClose?.();
      }
    };

    if (isOpen) {
      document.addEventListener('mousedown', handleClickOutside);
    }

    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [isOpen, onClose]);

  const markAsRead = (id: string, event?: React.MouseEvent) => {
    // Prevent event bubbling to ensure immediate action
    if (event) {
      event.stopPropagation();
      event.preventDefault();
    }

    setNotifications(prev =>
      prev.map(n => n.id === id ? { ...n, read: true } : n)
    );
    setUnreadCount(prev => Math.max(0, prev - 1));
  };

  const markAllAsRead = (event?: React.MouseEvent) => {
    // Prevent event bubbling
    if (event) {
      event.stopPropagation();
      event.preventDefault();
    }

    setNotifications(prev => prev.map(n => ({ ...n, read: true })));
    setUnreadCount(0);
  };

  // TEMÄ°ZLE butonu - tÃ¼m bildirimleri kaldÄ±r
  const clearAllNotifications = (event?: React.MouseEvent) => {
    // Prevent event bubbling
    if (event) {
      event.stopPropagation();
      event.preventDefault();
    }

    setNotifications([]);
    setUnreadCount(0);
  };

  // Push Notification: Enable/Disable
  const handleEnablePush = async (event?: React.MouseEvent) => {
    // Prevent event bubbling
    if (event) {
      event.stopPropagation();
      event.preventDefault();
    }

    setPushLoading(true);
    setPushError(null);

    try {
      if (pushSubscribed) {
        // Unsubscribe
        await PushClient.unsubscribeFromPush();
        setPushSubscribed(false);
        console.log('[NotificationPanel] âœ… Push notifications disabled');
      } else {
        // Subscribe
        await PushClient.subscribeToPush();
        setPushSubscribed(true);
        console.log('[NotificationPanel] âœ… Push notifications enabled');
      }
    } catch (error: any) {
      console.error('[NotificationPanel] âŒ Push toggle failed:', error);
      setPushError(error.message || 'Push notification iÅŸlemi baÅŸarÄ±sÄ±z');
    } finally {
      setPushLoading(false);
    }
  };

  // Push Notification: Send Test
  const handleTestPush = async (event?: React.MouseEvent) => {
    // Prevent event bubbling
    if (event) {
      event.stopPropagation();
      event.preventDefault();
    }

    if (!pushSubscribed) {
      setPushError('Ã–nce push bildirimlerini aktif etmelisiniz');
      return;
    }

    setPushLoading(true);
    setPushError(null);

    try {
      await PushClient.sendTestNotification();
      console.log('[NotificationPanel] âœ… Test notification sent');
    } catch (error: any) {
      console.error('[NotificationPanel] âŒ Test notification failed:', error);
      setPushError(error.message || 'Test bildirimi gÃ¶nderilemedi');
    } finally {
      setPushLoading(false);
    }
  };

  const getNotificationIcon = (type: string) => {
    switch (type) {
      case 'BUY': return <Icons.TrendingUp style={{ width: '14px', height: '14px', color: '#00ff00' }} />;
      case 'SELL': return <Icons.TrendingUp style={{ width: '14px', height: '14px', color: '#ff0000', transform: 'rotate(180deg)' }} />;
      case 'ALERT': return <Icons.AlertTriangle style={{ width: '14px', height: '14px', color: '#ffff00' }} />;
      default: return <Icons.Bot style={{ width: '14px', height: '14px', color: '#ffffff' }} />;
    }
  };

  // Confidence badge rengi
  const getConfidenceBadgeColor = (confidence: number) => {
    if (confidence >= 90) return '#00ff00'; // Neon green
    if (confidence >= 80) return '#ffff00'; // Yellow
    return '#ff8800'; // Orange
  };

  // EÄŸer kapalÄ±ysa hiÃ§bir ÅŸey render etme
  if (!isOpen) {
    return null;
  }

  return (
    <div
      ref={panelRef}
      style={{
        position: 'absolute',
        top: 'calc(100% + 8px)',
        right: 0,
        width: '320px',
        maxHeight: '400px',
        background: '#000',
        border: '2px solid #ffffff',
        borderRadius: '12px',
        boxShadow: '0 8px 32px rgba(255, 255, 255, 0.2)',
        zIndex: 10000,
        display: 'flex',
        flexDirection: 'column',
      }}
    >
      {/* Header - COMPACT */}
      <div style={{
            padding: '12px 14px', // KÃ¼Ã§Ã¼ltÃ¼ldÃ¼
            borderBottom: '1px solid #444',
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center'
          }}>
            <h3 className="neon-text" style={{ fontSize: '14px', margin: 0 }}>
              BÄ°LDÄ°RÄ°MLER
            </h3>
            <div style={{ display: 'flex', gap: '8px' }}>
              {unreadCount > 0 && (
                <button
                  onClick={(e) => markAllAsRead(e)}
                  style={{
                    background: 'transparent',
                    border: 'none',
                    color: '#8b8b8b',
                    fontSize: '10px',
                    cursor: 'pointer',
                    padding: '4px 6px',
                  }}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.color = '#ffffff';
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.color = '#8b8b8b';
                  }}
                >
                  Okundu
                </button>
              )}
              {notifications.length > 0 && (
                <button
                  onClick={(e) => clearAllNotifications(e)}
                  style={{
                    background: '#ff0000',
                    border: 'none',
                    color: '#ffffff',
                    fontSize: '10px',
                    fontWeight: '700',
                    cursor: 'pointer',
                    padding: '4px 8px',
                    borderRadius: '4px',
                  }}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.background = '#cc0000';
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.background = '#ff0000';
                  }}
                >
                  Temizle
                </button>
              )}
            </div>
          </div>

          {/* Notifications List - COMPACT */}
          <div style={{ flex: 1, overflowY: 'auto', padding: '6px' }}>
            {notifications.length === 0 ? (
              <div style={{ padding: '30px 16px', textAlign: 'center', color: '#8b8b8b' }}>
                <Icons.CircleCheck style={{ width: '40px', height: '40px', color: '#444', marginBottom: '8px' }} />
                <div style={{ fontSize: '12px' }}>Yeni bildirim yok</div>
              </div>
            ) : (
              notifications.map((notif) => (
                <div
                  key={notif.id}
                  onClick={(e) => markAsRead(notif.id, e)}
                  style={{
                    padding: '8px', // KÃ¼Ã§Ã¼ltÃ¼ldÃ¼
                    marginBottom: '6px',
                    background: notif.read ? 'rgba(255, 255, 255, 0.02)' : 'rgba(255, 255, 255, 0.08)',
                    border: `1px solid ${notif.read ? '#222' : '#ffffff'}`,
                    borderRadius: '6px',
                    cursor: 'pointer',
                    transition: 'all 0.2s',
                  }}
                  onMouseEnter={(e) => {
                    e.currentTarget.style.background = 'rgba(255, 255, 255, 0.12)';
                  }}
                  onMouseLeave={(e) => {
                    e.currentTarget.style.background = notif.read ? 'rgba(255, 255, 255, 0.02)' : 'rgba(255, 255, 255, 0.08)';
                  }}
                >
                  <div style={{ display: 'flex', gap: '8px', alignItems: 'flex-start' }}>
                    <div style={{ marginTop: '2px' }}>
                      {getNotificationIcon(notif.type)}
                    </div>
                    <div style={{ flex: 1 }}>
                      <div style={{
                        color: '#ffffff',
                        fontSize: '11px', // KÃ¼Ã§Ã¼ltÃ¼ldÃ¼
                        fontWeight: notif.read ? 'normal' : 'bold',
                        marginBottom: '4px',
                        lineHeight: '1.3'
                      }}>
                        {notif.message}
                      </div>
                      <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                        <span style={{ color: '#8b8b8b', fontSize: '9px' }}>
                          {notif.timestamp.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}
                        </span>
                        {/* Confidence Badge - KalÄ±cÄ± gÃ¶sterge */}
                        <span style={{
                          background: getConfidenceBadgeColor(notif.confidence),
                          color: '#000',
                          fontSize: '8px',
                          fontWeight: '700',
                          padding: '2px 4px',
                          borderRadius: '3px',
                        }}>
                          %{notif.confidence}
                        </span>
                      </div>
                    </div>
                    {!notif.read && (
                      <div style={{
                        width: '6px',
                        height: '6px',
                        borderRadius: '50%',
                        background: '#ffffff',
                        marginTop: '4px',
                      }} />
                    )}
                  </div>
                </div>
              ))
            )}
          </div>

          {/* Push Notifications Section - COMPACT */}
          {pushSupported && (
            <div style={{
              padding: '10px 12px',
              borderTop: '1px solid #444',
              borderBottom: '1px solid #444',
            }}>
              <div style={{
                display: 'flex',
                flexDirection: 'column',
                gap: '8px',
              }}>
                {/* Push Status & Toggle */}
                <div style={{
                  display: 'flex',
                  justifyContent: 'space-between',
                  alignItems: 'center',
                }}>
                  <div style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '6px',
                  }}>
                    <Icons.CircleAlert style={{
                      width: '14px',
                      height: '14px',
                      color: pushSubscribed ? '#00ff00' : '#8b8b8b'
                    }} />
                    <span style={{
                      fontSize: '11px',
                      fontWeight: '600',
                      color: pushSubscribed ? '#00ff00' : '#8b8b8b',
                    }}>
                      Push Bildirim
                    </span>
                  </div>
                  <button
                    onClick={(e) => handleEnablePush(e)}
                    disabled={pushLoading}
                    style={{
                      background: pushSubscribed ? '#00ff00' : '#444',
                      color: pushSubscribed ? '#000' : '#ffffff',
                      border: 'none',
                      borderRadius: '6px',
                      padding: '5px 10px',
                      fontSize: '10px',
                      fontWeight: '700',
                      cursor: pushLoading ? 'not-allowed' : 'pointer',
                      opacity: pushLoading ? 0.6 : 1,
                      transition: 'all 0.2s',
                    }}
                    onMouseEnter={(e) => {
                      if (!pushLoading) {
                        e.currentTarget.style.opacity = '0.8';
                      }
                    }}
                    onMouseLeave={(e) => {
                      if (!pushLoading) {
                        e.currentTarget.style.opacity = '1';
                      }
                    }}
                  >
                    {pushLoading ? 'YÃ¼kleniyor...' : pushSubscribed ? 'AKTÄ°F' : 'AKTÄ°F ET'}
                  </button>
                </div>

                {/* Test Button (only if subscribed) */}
                {pushSubscribed && (
                  <button
                    onClick={(e) => handleTestPush(e)}
                    disabled={pushLoading}
                    style={{
                      background: 'rgba(255, 255, 255, 0.08)',
                      border: '1px solid #444',
                      color: '#ffffff',
                      borderRadius: '6px',
                      padding: '6px 10px',
                      fontSize: '10px',
                      fontWeight: '600',
                      cursor: pushLoading ? 'not-allowed' : 'pointer',
                      opacity: pushLoading ? 0.6 : 1,
                      transition: 'all 0.2s',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      gap: '4px',
                    }}
                    onMouseEnter={(e) => {
                      if (!pushLoading) {
                        e.currentTarget.style.background = 'rgba(255, 255, 255, 0.15)';
                      }
                    }}
                    onMouseLeave={(e) => {
                      if (!pushLoading) {
                        e.currentTarget.style.background = 'rgba(255, 255, 255, 0.08)';
                      }
                    }}
                  >
                    <Icons.Bot style={{ width: '12px', height: '12px' }} />
                    Test Bildirimi GÃ¶nder
                  </button>
                )}

                {/* Error Display */}
                {pushError && (
                  <div style={{
                    background: 'rgba(255, 0, 0, 0.1)',
                    border: '1px solid #ff0000',
                    borderRadius: '4px',
                    padding: '6px 8px',
                    fontSize: '9px',
                    color: '#ff0000',
                    lineHeight: '1.3',
                  }}>
                    {pushError}
                  </div>
                )}
              </div>
            </div>
          )}

          {/* Footer - COMPACT */}
          <div style={{
            padding: '8px 12px',
            borderTop: '1px solid #444',
            textAlign: 'center',
            color: '#8b8b8b',
            fontSize: '9px',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            gap: '4px'
          }}>
            <Icons.Activity style={{ width: '10px', height: '10px', color: '#00ff00', animation: 'spin 2s linear infinite' }} />
            CanlÄ± (5s)
          </div>
        </div>
      </div>
  );
}
