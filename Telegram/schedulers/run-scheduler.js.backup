#!/usr/bin/env node
/**
 * ğŸ¤– TELEGRAM SCHEDULER RUNNER (Plain JavaScript)
 * PM2 ile kolay Ã§alÄ±ÅŸma iÃ§in JavaScript wrapper
 */

// Load environment variables from .env.local (2 directories up)
const path = require('path');
require('dotenv').config({
  path: path.join(__dirname, '../../.env.local')
});

const cron = require('node-cron');
const http = require('http');
const https = require('https');

const BASE_URL = process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000';
const BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN;
const CHAT_IDS = process.env.TELEGRAM_ALLOWED_CHAT_IDS ?
  process.env.TELEGRAM_ALLOWED_CHAT_IDS.split(',').map(id => id.trim()) : [];

console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
console.log('ğŸ¤– TELEGRAM SCHEDULER BAÅLATILIYOR...');
console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
console.log(`ğŸ“Š Base URL: ${BASE_URL}`);
console.log(`ğŸ‘¤ Chat IDs: ${CHAT_IDS.length} adet`);
console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');

// Simple HTTP GET
function httpGet(url) {
  return new Promise((resolve, reject) => {
    const protocol = url.startsWith('https') ? https : http;
    protocol.get(url, (res) => {
      let data = '';
      res.on('data', (chunk) => data += chunk);
      res.on('end', () => {
        try {
          resolve(JSON.parse(data));
        } catch (e) {
          resolve({ error: 'Parse error' });
        }
      });
    }).on('error', reject);
  });
}

// Sleep helper
function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

// HTTP POST helper (TA-Lib servisi iÃ§in gerekli)
function httpPost(url, data) {
  return new Promise((resolve, reject) => {
    const parsedUrl = new URL(url);
    const protocol = parsedUrl.protocol === 'https:' ? https : http;

    const options = {
      hostname: parsedUrl.hostname,
      port: parsedUrl.port,
      path: parsedUrl.pathname + parsedUrl.search,
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Content-Length': Buffer.byteLength(data)
      }
    };

    const req = protocol.request(options, (res) => {
      let responseData = '';
      res.on('data', (chunk) => responseData += chunk);
      res.on('end', () => {
        try {
          resolve(JSON.parse(responseData));
        } catch (e) {
          resolve({ error: 'Parse error', raw: responseData });
        }
      });
    });

    req.on('error', reject);
    req.write(data);
    req.end();
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DÄ°NAMÄ°K COÄ°N SEÃ‡Ä°M SÄ°STEMÄ° - Binance Top 200 USDT Pairs
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Global cache iÃ§in
let cachedTopCoins = null;
let lastCoinFetchTime = 0;
const COIN_CACHE_DURATION = 3600000; // 1 saat cache

/**
 * Binance'den top 200 USDT pair'i Ã§eker (24h volume bazÄ±nda)
 * Cache mekanizmasÄ± ile 1 saat sÃ¼reyle cache'lenir
 */
async function fetchTopUSDTPairs(limit = 200) {
  try {
    const now = Date.now();

    // Cache kontrolÃ¼
    if (cachedTopCoins && (now - lastCoinFetchTime) < COIN_CACHE_DURATION) {
      console.log('[Coin Selection] ğŸ“¦ Cache\'ten top coins alÄ±nÄ±yor...');
      return cachedTopCoins.slice(0, limit);
    }

    console.log('[Coin Selection] ğŸŒ Binance\'den top USDT pairs Ã§ekiliyor...');

    const url = 'https://fapi.binance.com/fapi/v1/ticker/24hr';
    const response = await httpGet(url);

    if (!response || !Array.isArray(response)) {
      console.error('[Coin Selection] âŒ Binance API hatasÄ±');
      return ['BTCUSDT', 'ETHUSDT', 'SOLUSDT', 'BNBUSDT', 'ADAUSDT', 'DOGEUSDT']; // Fallback
    }

    // Sadece USDT pair'leri filtrele ve volume'e gÃ¶re sÄ±rala
    const usdtPairs = response
      .filter(ticker =>
        ticker.symbol &&
        ticker.symbol.endsWith('USDT') &&
        !ticker.symbol.includes('DOWN') &&
        !ticker.symbol.includes('UP') &&
        !ticker.symbol.includes('BEAR') &&
        !ticker.symbol.includes('BULL')
      )
      .map(ticker => ({
        symbol: ticker.symbol,
        volume: parseFloat(ticker.quoteVolume || 0),
        priceChange: parseFloat(ticker.priceChangePercent || 0),
        lastPrice: parseFloat(ticker.lastPrice || 0),
        count: parseInt(ticker.count || 0) // Trade sayÄ±sÄ±
      }))
      .sort((a, b) => b.volume - a.volume) // Volume'e gÃ¶re sÄ±rala
      .slice(0, limit);

    // Cache'e kaydet
    cachedTopCoins = usdtPairs;
    lastCoinFetchTime = now;

    console.log(`[Coin Selection] âœ… ${usdtPairs.length} USDT pair Ã§ekildi (Top: ${usdtPairs[0].symbol})`);

    return usdtPairs;
  } catch (error) {
    console.error('[Coin Selection] âŒ Fetch hatasÄ±:', error.message);
    // Fallback: En popÃ¼ler coinler
    return ['BTCUSDT', 'ETHUSDT', 'SOLUSDT', 'BNBUSDT', 'ADAUSDT', 'DOGEUSDT'];
  }
}

/**
 * AkÄ±llÄ± coin seÃ§imi - FarklÄ± stratejiler ile
 * @param {number} count - SeÃ§ilecek coin sayÄ±sÄ±
 * @param {string} strategy - 'momentum' | 'volume' | 'volatile' | 'balanced'
 */
async function getSmartCoinSelection(count = 6, strategy = 'balanced') {
  try {
    const topCoins = await fetchTopUSDTPairs(200);

    if (!topCoins || topCoins.length === 0) {
      return ['BTCUSDT', 'ETHUSDT', 'SOLUSDT', 'BNBUSDT'];
    }

    let selected = [];

    switch (strategy) {
      case 'momentum':
        // En yÃ¼ksek pozitif price change
        selected = topCoins
          .filter(c => c.priceChange > 0)
          .sort((a, b) => b.priceChange - a.priceChange)
          .slice(0, count)
          .map(c => c.symbol);
        console.log(`[Coin Selection] ğŸš€ Momentum stratejisi: ${selected.slice(0, 3).join(', ')}...`);
        break;

      case 'volume':
        // En yÃ¼ksek volume
        selected = topCoins
          .slice(0, count)
          .map(c => c.symbol);
        console.log(`[Coin Selection] ğŸ“Š Volume stratejisi: ${selected.slice(0, 3).join(', ')}...`);
        break;

      case 'volatile':
        // En volatil (yÃ¼ksek price change - pozitif veya negatif)
        selected = topCoins
          .sort((a, b) => Math.abs(b.priceChange) - Math.abs(a.priceChange))
          .slice(0, count)
          .map(c => c.symbol);
        console.log(`[Coin Selection] âš¡ Volatile stratejisi: ${selected.slice(0, 3).join(', ')}...`);
        break;

      case 'balanced':
      default:
        // KarÄ±ÅŸÄ±k: Top volume'den bazÄ±larÄ± + momentum'dan bazÄ±larÄ±
        const topVolume = topCoins.slice(0, Math.ceil(count * 0.6)).map(c => c.symbol);
        const topMomentum = topCoins
          .filter(c => c.priceChange > 0)
          .sort((a, b) => b.priceChange - a.priceChange)
          .slice(0, Math.ceil(count * 0.4))
          .map(c => c.symbol);

        selected = [...new Set([...topVolume, ...topMomentum])].slice(0, count);
        console.log(`[Coin Selection] âš–ï¸ Balanced stratejisi: ${selected.slice(0, 3).join(', ')}...`);
        break;
    }

    // Fallback: EÄŸer yeterli coin seÃ§ilemediyse
    if (selected.length < count) {
      const fallback = ['BTCUSDT', 'ETHUSDT', 'SOLUSDT', 'BNBUSDT', 'ADAUSDT', 'DOGEUSDT'];
      while (selected.length < count && fallback.length > 0) {
        const coin = fallback.shift();
        if (!selected.includes(coin)) {
          selected.push(coin);
        }
      }
    }

    return selected;
  } catch (error) {
    console.error('[Coin Selection] âŒ Smart selection hatasÄ±:', error.message);
    return ['BTCUSDT', 'ETHUSDT', 'SOLUSDT', 'BNBUSDT'];
  }
}

/**
 * Rotasyon sistemi - Her Ã§aÄŸrÄ±da farklÄ± coinler seÃ§
 * Top 50 coin arasÄ±nda rotasyon yapar
 */
let rotationIndex = 0;
async function getRotatedCoins(count = 6) {
  try {
    const topCoins = await fetchTopUSDTPairs(50); // Top 50'den seÃ§

    if (!topCoins || topCoins.length === 0) {
      return ['BTCUSDT', 'ETHUSDT', 'SOLUSDT', 'BNBUSDT'];
    }

    const symbols = topCoins.map(c => c.symbol);
    const selected = [];

    // Rotasyon ile seÃ§
    for (let i = 0; i < count; i++) {
      const index = (rotationIndex + i) % symbols.length;
      selected.push(symbols[index]);
    }

    // Bir sonraki Ã§aÄŸrÄ± iÃ§in index'i gÃ¼ncelle
    rotationIndex = (rotationIndex + count) % symbols.length;

    console.log(`[Coin Selection] ğŸ”„ Rotasyon: ${selected.slice(0, 3).join(', ')}... (Index: ${rotationIndex})`);

    return selected;
  } catch (error) {
    console.error('[Coin Selection] âŒ Rotation hatasÄ±:', error.message);
    return ['BTCUSDT', 'ETHUSDT', 'SOLUSDT', 'BNBUSDT'];
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DÄ°NAMÄ°K COÄ°N SEÃ‡Ä°M SÄ°STEMÄ° SONU
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Telegram mesaj gÃ¶nder (with retry and timeout)
async function sendTelegramMessage(message, maxRetries = 3) {
  console.log('[DEBUG sendTelegramMessage] Message received:', typeof message, message ? message.length : 'UNDEFINED');
  console.log('[DEBUG sendTelegramMessage] Message preview:', message ? message.substring(0, 50) : 'NO MESSAGE');

  if (!BOT_TOKEN || CHAT_IDS.length === 0) {
    console.log('[Telegram] âš ï¸  Bot token veya chat ID bulunamadÄ±');
    return;
  }

  for (const chatId of CHAT_IDS) {
    let retries = 0;
    let success = false;

    while (retries < maxRetries && !success) {
      try {
        const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;
        const data = JSON.stringify({
          chat_id: chatId,
          text: message,
          parse_mode: 'HTML'
        });

        console.log('[DEBUG sendTelegramMessage] JSON data:', data.substring(0, 150));

        await new Promise((resolve, reject) => {
          const timeout = setTimeout(() => {
            req.destroy();
            reject(new Error('Request timeout'));
          }, 10000); // 10 second timeout

          const req = https.request(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Content-Length': Buffer.byteLength(data, 'utf8')
            }
          }, (res) => {
            clearTimeout(timeout);
            let responseData = '';
            res.on('data', (chunk) => responseData += chunk);
            res.on('end', () => {
              if (res.statusCode === 200) {
                resolve(responseData);
              } else {
                reject(new Error(`HTTP ${res.statusCode}: ${responseData}`));
              }
            });
          });

          req.on('error', (err) => {
            clearTimeout(timeout);
            reject(err);
          });

          req.write(data);
          req.end();
        });

        console.log(`[Telegram] âœ… Mesaj gÃ¶nderildi: ${chatId}`);
        success = true;

        // Delay between messages to prevent rate limiting
        await sleep(500);

      } catch (error) {
        retries++;
        console.error(`[Telegram] âŒ Deneme ${retries}/${maxRetries} baÅŸarÄ±sÄ±z: ${error.message}`);

        if (retries < maxRetries) {
          // Exponential backoff: 1s, 2s, 4s
          const delay = Math.pow(2, retries) * 1000;
          console.log(`[Telegram] â³ ${delay}ms bekleniyor...`);
          await sleep(delay);
        } else {
          console.error(`[Telegram] âŒ TÃ¼m denemeler baÅŸarÄ±sÄ±z oldu: ${chatId}`);
        }
      }
    }
  }
}

// ============================================================================
// SCHEDULER FUNCTIONS
// ============================================================================

async function sendNirvanaDaily() {
  try {
    console.log('\n[Scheduler] ğŸ“Š Nirvana gÃ¼nlÃ¼k Ã¶zet gÃ¶nderiliyor...');
    const data = await httpGet(`${BASE_URL}/api/nirvana`);

    if (!data.success) {
      console.log('[Scheduler] âŒ Nirvana API hatasÄ±');
      return;
    }

    const message = `
â•­â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•®
â”ƒ ğŸŒŸ NÄ°RVANA Ã–ZET ğŸŒŸ
â”œâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”¤
â”ƒ ğŸ“Š Aktif Strateji: ${data.data.activeStrategies}/${data.data.totalStrategies}
â”ƒ ğŸ¯ Toplam Sinyal: ${data.data.totalSignals}
â”ƒ ${data.data.marketSentiment === 'BULLISH' ? 'ğŸŸ¢ YÃœKSELÄ°Å' : data.data.marketSentiment === 'BEARISH' ? 'ğŸ”´ DÃœÅÃœÅ' : 'ğŸŸ¡ NÃ–TR'} (${data.data.sentimentScore})
â”œâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”¤
â”ƒ âŒš ${new Date().toLocaleString('tr-TR', { hour: '2-digit', minute: '2-digit' })}
â•°â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•¯
`.trim();

    await sendTelegramMessage(message);
    console.log('[Scheduler] âœ… Nirvana Ã¶zet gÃ¶nderildi');
  } catch (error) {
    console.error('[Scheduler] âŒ Nirvana hatasÄ±:', error.message);
  }
}

// DEVRE DIÅI BIRAKILDI - HABER BÄ°LDÄ°RÄ°MLERÄ° KALDIRILDI
/*
async function sendCryptoNews() {
  try {
    console.log('\n[Scheduler] ğŸ“° Crypto News kontrol ediliyor...');
    const data = await httpGet(`${BASE_URL}/api/crypto-news?refresh=true`);

    if (!data.success || !data.data || data.data.length === 0) {
      console.log('[Scheduler] â„¹ï¸  Yeni haber bulunamadÄ±');
      return;
    }

    const importantNews = data.data.filter(n => n.impactScore >= 8);

    for (const news of importantNews.slice(0, 3)) {
      const message = `
â•­â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•®
â”ƒ ğŸ“° KRÄ°PTO HABER
â”œâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”¤
â”ƒ <b>${news.titleTR || news.title}</b>
â”œâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”¤
â”ƒ ${(news.descriptionTR || news.description || '').substring(0, 150)}...
â”œâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”¤
â”ƒ ğŸ¯ Etki: ${news.impactScore}/10
â”ƒ âŒš ${new Date().toLocaleString('tr-TR', { hour: '2-digit', minute: '2-digit' })}
â•°â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•¯
`.trim();

      await sendTelegramMessage(message);
      await new Promise(resolve => setTimeout(resolve, 1000)); // 1s bekle
    }

    console.log('[Scheduler] âœ… Crypto News gÃ¶nderildi');
  } catch (error) {
    console.error('[Scheduler] âŒ Crypto News hatasÄ±:', error.message);
  }
}
*/

async function sendMarketCorrelation() {
  try {
    console.log('\n[Scheduler] ğŸ“Š Market Correlation sinyalleri gÃ¶nderiliyor...');
    const data = await httpGet(`${BASE_URL}/api/market-correlation?limit=5`);

    if (!data.success || !data.data || !data.data.correlations || data.data.correlations.length === 0) {
      console.log('[Scheduler] â„¹ï¸  Market Correlation verisi yok');
      return;
    }

    const topCoins = data.data.correlations.slice(0, 5);
    let coinList = '';
    topCoins.forEach((coin, index) => {
      const medal = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', '4ï¸âƒ£', '5ï¸âƒ£'][index];
      const correlation = (coin.btcCorrelation * 100).toFixed(0);
      coinList += `â”ƒ ${medal} ${coin.symbol}: ${correlation}% (${coin.omnipotentScore.toFixed(0)})\n`;
    });

    const message = `
â•­â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•®
â”ƒ ğŸ“Š MARKET CORRELATION
â”œâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”¤
${coinList}â”œâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”¤
â”ƒ âŒš ${new Date().toLocaleString('tr-TR', { hour: '2-digit', minute: '2-digit' })}
â•°â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•¯
`.trim();

    await sendTelegramMessage(message);
    console.log('[Scheduler] âœ… Market Correlation gÃ¶nderildi');
  } catch (error) {
    console.error('[Scheduler] âŒ Market Correlation hatasÄ±:', error.message);
  }
}

async function sendOmnipotentFutures() {
  try {
    console.log('\n[Scheduler] ğŸ¯ Omnipotent Futures sinyalleri gÃ¶nderiliyor...');
    const data = await httpGet(`${BASE_URL}/api/omnipotent-futures?limit=10`);

    if (!data.success || !data.data || !data.data.futures || data.data.futures.length === 0) {
      console.log('[Scheduler] â„¹ï¸  Omnipotent Futures verisi yok');
      return;
    }

    const strongSignals = data.data.futures.filter(s => s.wyckoffScore >= 70);

    if (strongSignals.length === 0) {
      console.log('[Scheduler] â„¹ï¸  GÃ¼Ã§lÃ¼ Wyckoff sinyali yok');
      return;
    }

    const topSignal = strongSignals[0];
    const phaseEmoji = {
      'ACCUMULATION': 'ğŸŸ¢',
      'MARKUP': 'ğŸš€',
      'DISTRIBUTION': 'ğŸ”´',
      'MARKDOWN': 'â¬‡ï¸'
    };

    const message = `
â•­â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•®
â”ƒ ğŸ¯ OMNIPOTENT FUTURES
â”œâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”¤
â”ƒ ğŸ’° ${topSignal.symbol}
â”ƒ ${phaseEmoji[topSignal.wyckoffPhase] || 'âšª'} ${topSignal.wyckoffPhase}
â”ƒ ğŸ“ˆ Skor: ${topSignal.wyckoffScore.toFixed(0)}/100
â”ƒ ğŸ’ Confidence: ${(topSignal.confidence * 100).toFixed(0)}%
â”œâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”¤
â”ƒ ğŸ”¥ ${strongSignals.length} gÃ¼Ã§lÃ¼ sinyal aktif
â”ƒ âŒš ${new Date().toLocaleString('tr-TR', { hour: '2-digit', minute: '2-digit' })}
â•°â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•¯
`.trim();

    await sendTelegramMessage(message);
    console.log('[Scheduler] âœ… Omnipotent Futures gÃ¶nderildi');
  } catch (error) {
    console.error('[Scheduler] âŒ Omnipotent Futures hatasÄ±:', error.message);
  }
}

async function sendBreakoutSignals() {
  try {
    console.log('\n[Scheduler] ğŸ’¥ Breakout Signals kontrol ediliyor...');
    const data = await httpGet(`${BASE_URL}/api/breakout-signals?limit=10`);

    if (!data.success || !data.data || data.data.length === 0) {
      console.log('[Scheduler] â„¹ï¸  Breakout signal verisi yok');
      return;
    }

    const highConfidenceSignals = data.data.filter(s => s.confidence >= 0.75);

    if (highConfidenceSignals.length === 0) {
      console.log('[Scheduler] â„¹ï¸  YÃ¼ksek confidence breakout yok');
      return;
    }

    const buySignals = highConfidenceSignals.filter(s => s.signal === 'BUY').length;
    const sellSignals = highConfidenceSignals.filter(s => s.signal === 'SELL').length;

    const message = `
â•­â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•®
â”ƒ ğŸ’¥ BREAKOUT SIGNALS
â”œâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”¤
â”ƒ ğŸŸ¢ AlÄ±ÅŸ: ${buySignals} sinyal
â”ƒ ğŸ”´ SatÄ±ÅŸ: ${sellSignals} sinyal
â”ƒ ğŸ’ Toplam: ${highConfidenceSignals.length} yÃ¼ksek gÃ¼ven
â”œâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”¤
â”ƒ âŒš ${new Date().toLocaleString('tr-TR', { hour: '2-digit', minute: '2-digit' })}
â•°â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•¯
`.trim();

    await sendTelegramMessage(message);
    console.log('[Scheduler] âœ… Breakout Signals gÃ¶nderildi');
  } catch (error) {
    console.error('[Scheduler] âŒ Breakout Signals hatasÄ±:', error.message);
  }
}

async function sendBTCETHAnalysis() {
  try {
    console.log('\n[Scheduler] ğŸ”— BTC-ETH Analysis gÃ¶nderiliyor...');
    const data = await httpGet(`${BASE_URL}/api/btc-eth-analysis`);

    if (!data.success || !data.data) {
      console.log('[Scheduler] âŒ BTC-ETH Analysis hatasÄ±');
      return;
    }

    const { correlation30d, correlation7d, trend, volumeRatio } = data.data;
    const trendEmoji = trend === 'Rising' ? 'ğŸ“ˆ' : trend === 'Falling' ? 'ğŸ“‰' : 'â¡ï¸';

    const message = `
â•­â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•®
â”ƒ ğŸ”— BTC-ETH ANALYSIS
â”œâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”¤
â”ƒ ğŸ“Š 30 GÃ¼n: ${(correlation30d * 100).toFixed(0)}%
â”ƒ ğŸ“… 7 GÃ¼n: ${(correlation7d * 100).toFixed(0)}%
â”ƒ ${trendEmoji} Trend: ${trend}
â”ƒ ğŸ“Š Volume: ${volumeRatio.toFixed(2)}x
â”œâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”¤
â”ƒ âŒš ${new Date().toLocaleString('tr-TR', { hour: '2-digit', minute: '2-digit' })}
â•°â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•¯
`.trim();

    await sendTelegramMessage(message);
    console.log('[Scheduler] âœ… BTC-ETH Analysis gÃ¶nderildi');
  } catch (error) {
    console.error('[Scheduler] âŒ BTC-ETH Analysis hatasÄ±:', error.message);
  }
}

// ============================================================================
// CRON JOBS
// ============================================================================

// Test mesajÄ± (baÅŸlangÄ±Ã§ta)
setTimeout(async () => {
  const testMessage = `ğŸ¤– TELEGRAM SCHEDULER AKTÄ°F!

âœ… Scheduler servisi baÅŸarÄ±yla baÅŸlatÄ±ldÄ±
â° ${new Date().toLocaleString('tr-TR')}

ğŸ“… Zamanlamalar:
- ğŸ• Saatlik: Market sinyalleri
- ğŸ•“ 4 Saatlik: Futures + Haberler
- ğŸ“… GÃ¼nlÃ¼k: Nirvana + BTC-ETH
- ğŸ“† HaftalÄ±k: Nirvana Ã¶zet

Sistem 7/24 Ã§alÄ±ÅŸÄ±yor! ğŸš€`;

  console.log('[DEBUG] Test message length:', testMessage.length);
  console.log('[DEBUG] Test message preview:', testMessage.substring(0, 100));
  console.log('[DEBUG] BOT_TOKEN length:', (BOT_TOKEN || '').length);
  console.log('[DEBUG] CHAT_IDS:', CHAT_IDS);

  await sendTelegramMessage(testMessage);
}, 3000);

// âš¡ TOP BUY SÄ°NYALLERÄ° (Her 15 dakikada) - ENHANCED VERSION
async function sendTopBuySignals() {
  try {
    console.log('\n[Scheduler] ğŸ¯ TÃœMÃœ STRATEJÄ°LER taranÄ±yor (6 strateji)...');

    // TÃœM sinyal kaynaklarÄ±nÄ± paralel olarak Ã§ek (6 strateji)
    const [aiSignals, quantumSignals, conservativeSignals, breakoutSignals, omnipotentSignals, nirvanaData] = await Promise.all([
      httpGet(`${BASE_URL}/api/ai-signals?limit=20`).catch(() => ({ data: { signals: [] } })),
      httpGet(`${BASE_URL}/api/quantum-signals?limit=20`).catch(() => ({ data: { signals: [] } })),
      httpGet(`${BASE_URL}/api/conservative-signals?limit=20`).catch(() => ({ data: { signals: [] } })),
      httpGet(`${BASE_URL}/api/breakout-retest?limit=20`).catch(() => ({ data: { signals: [] } })),
      httpGet(`${BASE_URL}/api/omnipotent-futures?limit=20`).catch(() => ({ data: { futures: [] } })),
      httpGet(`${BASE_URL}/api/nirvana`).catch(() => ({ data: { strategies: [] } })),
    ]);

    // TÃ¼m BUY sinyallerini topla
    const allSignals = [];

    // AI Signals
    if (aiSignals.data?.signals) {
      aiSignals.data.signals.forEach(s => {
        if (s.type === 'BUY' && s.confidence >= 70) {
          allSignals.push({
            symbol: s.symbol,
            confidence: s.confidence,
            strategy: 'AI',
            price: s.price,
            targetPrice: s.price ? s.price * 1.05 : null, // 5% target
            stopLoss: s.price ? s.price * 0.98 : null, // 2% stop loss
            riskReward: '1:2.5',
            reason: s.reasoning?.substring(0, 60) || 'AI Analizi'
          });
        }
      });
    }

    // Quantum Signals
    if (quantumSignals.data?.signals) {
      quantumSignals.data.signals.forEach(s => {
        if (s.type === 'BUY' && s.confidence >= 70) {
          allSignals.push({
            symbol: s.symbol,
            confidence: s.confidence,
            strategy: 'Quantum',
            price: s.price,
            targetPrice: s.price ? s.price * 1.06 : null, // 6% target
            stopLoss: s.price ? s.price * 0.97 : null, // 3% stop loss
            riskReward: '1:2',
            quantumScore: s.quantumScore,
            reason: 'Quantum Portfolio Optimization'
          });
        }
      });
    }

    // Conservative Signals
    if (conservativeSignals.data?.signals) {
      conservativeSignals.data.signals.forEach(s => {
        if (s.type === 'BUY' && s.confidence >= 70) {
          allSignals.push({
            symbol: s.symbol,
            confidence: s.confidence,
            strategy: 'Conservative',
            price: s.price,
            targetPrice: s.price ? s.price * 1.04 : null, // 4% target (conservative)
            stopLoss: s.price ? s.price * 0.99 : null, // 1% stop loss (tight)
            riskReward: '1:4',
            reason: 'Low Risk High Volume'
          });
        }
      });
    }

    // Breakout Signals
    if (breakoutSignals.data?.signals) {
      breakoutSignals.data.signals.forEach(s => {
        if (s.type === 'BUY' && s.confidence >= 70) {
          allSignals.push({
            symbol: s.symbol,
            confidence: s.confidence,
            strategy: 'Breakout',
            price: s.price,
            targetPrice: s.price ? s.price * 1.08 : null, // 8% target (aggressive)
            stopLoss: s.price ? s.price * 0.96 : null, // 4% stop loss
            riskReward: '1:2',
            reason: 'Support/Resistance Break'
          });
        }
      });
    }

    // Omnipotent Futures (Wyckoff ACCUMULATION ve MARKUP fazlarÄ±)
    if (omnipotentSignals.data?.futures) {
      omnipotentSignals.data.futures.forEach(s => {
        if ((s.wyckoffPhase === 'ACCUMULATION' || s.wyckoffPhase === 'MARKUP') && s.confidence >= 75) {
          allSignals.push({
            symbol: s.symbol,
            confidence: s.confidence,
            strategy: 'Omnipotent',
            price: s.price,
            targetPrice: s.price ? s.price * 1.10 : null, // 10% target (high potential)
            stopLoss: s.price ? s.price * 0.95 : null, // 5% stop loss
            riskReward: '1:2',
            wyckoffPhase: s.wyckoffPhase,
            reason: `Wyckoff ${s.wyckoffPhase}`
          });
        }
      });
    }

    // Nirvana Best Strategies (En yÃ¼ksek BUY sinyallerine sahip stratejiler)
    if (nirvanaData.data?.strategies) {
      const bestStrategies = nirvanaData.data.strategies
        .filter(st => st.status === 'active' && st.buySignals > 0 && st.avgConfidence >= 70)
        .sort((a, b) => (b.buySignals * b.avgConfidence) - (a.buySignals * a.avgConfidence))
        .slice(0, 3); // En iyi 3 strateji

      bestStrategies.forEach(st => {
        // Her stratejinin bir temsili sinyali olarak ekle
        allSignals.push({
          symbol: 'MULTI', // Ã‡oklu coin stratejisi
          confidence: Math.round(st.avgConfidence),
          strategy: 'Nirvana',
          strategyName: st.name.substring(0, 25),
          buySignalsCount: st.buySignals,
          price: null, // Multi-coin, tek fiyat yok
          reason: `${st.buySignals} BUY signals`
        });
      });
    }

    if (allSignals.length === 0) {
      console.log('[Scheduler] â„¹ï¸  Yeterli gÃ¼venilirlikte AL sinyali yok (min %70)');
      return;
    }

    // Confidence'a gÃ¶re sÄ±rala
    allSignals.sort((a, b) => b.confidence - a.confidence);

    // Birbirinden farklÄ± coinleri seÃ§ (diversity iÃ§in) - Nirvana hariÃ§
    const uniqueSignals = [];
    const seenSymbols = new Set();

    for (const signal of allSignals) {
      if (signal.symbol === 'MULTI') {
        // Nirvana stratejilerini her zaman ekle (multi-coin)
        uniqueSignals.push(signal);
      } else if (!seenSymbols.has(signal.symbol) && uniqueSignals.length < 10) {
        uniqueSignals.push(signal);
        seenSymbols.add(signal.symbol);
      }
      if (uniqueSignals.length >= 10) break; // Maksimum 10 sinyal
    }

    if (uniqueSignals.length === 0) {
      console.log('[Scheduler] â„¹ï¸  Unique AL sinyali bulunamadÄ±');
      return;
    }

    // PREMIUM TELEGRAM MESAJI OLUÅTUR
    let message = 'â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n';
    message += 'â•‘ ğŸ’ PREMIUM TRADE SIGNALS ğŸ’ â•‘\n';
    message += 'â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£\n';
    message += `â•‘ ğŸ“… ${new Date().toLocaleString('tr-TR', {
      day: '2-digit',
      month: 'short',
      hour: '2-digit',
      minute: '2-digit'
    })}\n`;
    message += 'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';

    uniqueSignals.forEach((signal, index) => {
      const medal = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'][index] || `${index + 1}ï¸âƒ£`;
      const strategyIcon = {
        'AI': 'ğŸ¤–',
        'Quantum': 'âš›ï¸',
        'Conservative': 'ğŸ›¡ï¸',
        'Breakout': 'ğŸ’¥',
        'Omnipotent': 'ğŸ¯',
        'Nirvana': 'ğŸŒŸ'
      }[signal.strategy] || 'ğŸ“Š';

      message += `${medal} <b>${signal.symbol}</b>\n`;
      message += `${strategyIcon} ${signal.strategy}`;
      if (signal.strategyName) {
        message += ` (${signal.strategyName})`;
      }
      message += `\n`;

      message += `ğŸ“Š GÃ¼ven: ${signal.confidence}%\n`;

      if (signal.price && typeof signal.price === 'number') {
        message += `ğŸ’° GiriÅŸ: $${signal.price.toFixed(signal.price < 1 ? 6 : 2)}\n`;

        if (signal.targetPrice) {
          message += `ğŸ¯ Hedef: $${signal.targetPrice.toFixed(signal.targetPrice < 1 ? 6 : 2)} (+${((signal.targetPrice/signal.price - 1) * 100).toFixed(1)}%)\n`;
        }

        if (signal.stopLoss) {
          message += `ğŸ›‘ Stop: $${signal.stopLoss.toFixed(signal.stopLoss < 1 ? 6 : 2)} (${((signal.stopLoss/signal.price - 1) * 100).toFixed(1)}%)\n`;
        }

        if (signal.riskReward) {
          message += `âš–ï¸ Risk/Reward: ${signal.riskReward}\n`;
        }
      } else if (signal.buySignalsCount) {
        message += `ğŸ“ˆ ${signal.buySignalsCount} aktif AL sinyali\n`;
      }

      if (signal.quantumScore) {
        message += `ğŸ”¬ Quantum: ${signal.quantumScore}/100\n`;
      }

      if (signal.wyckoffPhase) {
        message += `ğŸ“Š Faz: ${signal.wyckoffPhase}\n`;
      }

      if (signal.reason) {
        message += `ğŸ’¡ ${signal.reason}\n`;
      }

      message += '\n';
    });

    // DISCLAIMER
    message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
    message += 'ğŸ“Š <b>Toplam:</b> ' + allSignals.length + ' sinyal tarandÄ±\n';
    message += 'âœ¨ <b>SeÃ§ilen:</b> ' + uniqueSignals.length + ' sinyal\n';
    message += 'ğŸ¯ <b>Stratejiler:</b> 6 (AI, Quantum, Conservative, Breakout, Omnipotent, Nirvana)\n\n';
    message += 'âš ï¸ <b>UYARI:</b>\n';
    message += 'â€¢ GiriÅŸ-Ã§Ä±kÄ±ÅŸ fiyatlarÄ± ve risk yÃ¶netimi kiÅŸiseldir\n';
    message += 'â€¢ YatÄ±rÄ±m kararlarÄ± size aittir\n';
    message += 'â€¢ AnlÄ±k piyasa koÅŸullarÄ±nÄ± takip edin\n';
    message += 'â€¢ Stop-loss kullanmayÄ± unutmayÄ±n\n\n';
    message += 'ğŸ’¼ Bu bilgiler yalnÄ±zca bilgilendirme amaÃ§lÄ±dÄ±r.';

    // Message validation - boÅŸ mesaj gÃ¶nderme!
    if (!message || message.trim().length === 0) {
      console.log('[Scheduler] âš ï¸  Mesaj iÃ§eriÄŸi boÅŸ, gÃ¶nderilmiyor');
      return;
    }

    await sendTelegramMessage(message);
    console.log(`[Scheduler] âœ… ${uniqueSignals.length} PREMIUM AL sinyali gÃ¶nderildi (6 strateji tarandÄ±)`);

  } catch (error) {
    console.error('[Scheduler] âŒ Top Buy Signals hatasÄ±:', error.message);
  }
}

// âš¡ GLOBAL MARKET CRITICAL EVENTS SCANNER (Multi-Timeframe Analysis)
async function sendCriticalMarketEvents() {
  try {
    console.log('\n[Scheduler] ğŸŒ GLOBAL MARKET CRITICAL EVENTS taranÄ±yor...');

    // 1. Binance futures verilerini Ã§ek (tÃ¼m coinler 24h deÄŸiÅŸim ile)
    const futuresData = await httpGet(`${BASE_URL}/api/binance/futures`).catch(() => ({ data: { all: [] } }));

    if (!futuresData.data?.all || futuresData.data.all.length === 0) {
      console.log('[Scheduler] âš ï¸  Binance futures data alÄ±namadÄ±');
      return;
    }

    const criticalEvents = [];

    // 2. HER COIN iÃ§in kritik olaylarÄ± tespit et
    futuresData.data.all.forEach(coin => {
      const symbol = coin.symbol;
      const price = parseFloat(coin.price);
      const change24h = parseFloat(coin.changePercent24h);
      const volume24h = parseFloat(coin.volume24h);
      const highPrice24h = parseFloat(coin.highPrice24h);
      const lowPrice24h = parseFloat(coin.lowPrice24h);

      // KRÄ°TÄ°K OLAY 1: BÃ¼yÃ¼k fiyat hareketleri (Â±8% Ã¼zeri)
      if (Math.abs(change24h) >= 8) {
        const importance = Math.abs(change24h) >= 15 ? 'CRITICAL' : 'HIGH';
        criticalEvents.push({
          type: change24h > 0 ? 'STRONG_PUMP' : 'STRONG_DUMP',
          symbol,
          importance,
          score: Math.abs(change24h),
          data: {
            price,
            change24h,
            volume24h,
            reason: change24h > 0 ? `GÃ¼Ã§lÃ¼ yÃ¼kseliÅŸ (+${change24h.toFixed(1)}%)` : `GÃ¼Ã§lÃ¼ dÃ¼ÅŸÃ¼ÅŸ (${change24h.toFixed(1)}%)`
          }
        });
      }

      // KRÄ°TÄ°K OLAY 2: ATH/ATL yakÄ±nlÄ±ÄŸÄ±
      const nearATH = ((price - highPrice24h) / highPrice24h) * 100;
      const nearATL = ((price - lowPrice24h) / lowPrice24h) * 100;

      if (nearATH >= -2 && nearATH <= 0) {
        criticalEvents.push({
          type: 'NEAR_ATH',
          symbol,
          importance: 'HIGH',
          score: 90 + nearATH * 5, // YaklaÅŸtÄ±kÃ§a skor artar
          data: {
            price,
            change24h,
            highPrice24h,
            reason: `24h zirvesine Ã§ok yakÄ±n (${Math.abs(nearATH).toFixed(2)}% altÄ±nda)`
          }
        });
      }

      if (Math.abs(nearATL) <= 2 && nearATL >= 0) {
        criticalEvents.push({
          type: 'NEAR_ATL',
          symbol,
          importance: 'HIGH',
          score: 90 - nearATL * 5,
          data: {
            price,
            change24h,
            lowPrice24h,
            reason: `24h dipine Ã§ok yakÄ±n (${nearATL.toFixed(2)}% Ã¼stÃ¼nde)`
          }
        });
      }

      // KRÄ°TÄ°K OLAY 3: YÃ¼ksek volume (top 50)
      // Not: Volume sÄ±ralamasÄ± yapÄ±lacak
    });

    // 3. Stratejilerden kritik sinyalleri ekle
    const [quantumData, omnipotentData, nirvanaData] = await Promise.all([
      httpGet(`${BASE_URL}/api/quantum-signals?limit=10`).catch(() => ({ data: { signals: [] } })),
      httpGet(`${BASE_URL}/api/omnipotent-futures?limit=10`).catch(() => ({ data: { futures: [] } })),
      httpGet(`${BASE_URL}/api/nirvana`).catch(() => ({ data: { strategies: [] } }))
    ]);

    // Quantum sinyalleri - %95+ confidence kritik
    if (quantumData.data?.signals) {
      quantumData.data.signals.forEach(s => {
        if (s.confidence >= 95 && s.type === 'BUY') {
          criticalEvents.push({
            type: 'QUANTUM_SIGNAL',
            symbol: s.symbol,
            importance: 'CRITICAL',
            score: s.confidence + (s.quantumScore || 0) / 10,
            data: {
              price: s.price,
              confidence: s.confidence,
              quantumScore: s.quantumScore,
              reason: `Ultra yÃ¼ksek gÃ¼ven Quantum sinyali (%${s.confidence})`
            }
          });
        }
      });
    }

    // Omnipotent - ACCUMULATION fazÄ± kritik
    if (omnipotentData.data?.futures) {
      omnipotentData.data.futures.forEach(s => {
        if (s.wyckoffPhase === 'ACCUMULATION' && s.confidence >= 80) {
          criticalEvents.push({
            type: 'WYCKOFF_ACCUMULATION',
            symbol: s.symbol,
            importance: 'HIGH',
            score: 85 + s.confidence / 10,
            data: {
              price: s.price,
              phase: s.wyckoffPhase,
              confidence: s.confidence,
              reason: 'Wyckoff ACCUMULATION fazÄ± - BÃ¼yÃ¼k fÄ±rsat'
            }
          });
        }
      });
    }

    // Nirvana - Multi-strateji consensus
    if (nirvanaData.data?.strategies) {
      const strongConsensus = nirvanaData.data.strategies
        .filter(st => st.status === 'active' && st.buySignals >= 5 && st.avgConfidence >= 85);

      strongConsensus.forEach(st => {
        criticalEvents.push({
          type: 'MULTI_STRATEGY_CONSENSUS',
          symbol: 'MULTI',
          importance: 'HIGH',
          score: 85 + st.buySignals,
          data: {
            strategyName: st.name.substring(0, 30),
            buySignals: st.buySignals,
            confidence: st.avgConfidence,
            reason: `${st.buySignals} strateji aynÄ± fikirde (%${st.avgConfidence.toFixed(0)})`
          }
        });
      });
    }

    // 4. Ã–NEM SIRASINA GÃ–RE SIRALA
    criticalEvents.sort((a, b) => b.score - a.score);

    if (criticalEvents.length === 0) {
      console.log('[Scheduler] â„¹ï¸  Kritik market olayÄ± tespit edilmedi');
      return;
    }

    // 5. EN Ã–NEMLÄ° 7 OLAYI SEÃ‡
    const topEvents = criticalEvents.slice(0, 7);

    // 6. TELEGRAM MESAJI OLUÅTUR
    let message = 'â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n';
    message += 'â•‘ ğŸŒ GLOBAL MARKET CRITICAL EVENTS â•‘\n';
    message += 'â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£\n';
    message += `â•‘ ğŸ“… ${new Date().toLocaleString('tr-TR', {
      day: '2-digit',
      month: 'short',
      hour: '2-digit',
      minute: '2-digit'
    })}\n`;
    message += 'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';

    const typeIcons = {
      'STRONG_PUMP': 'ğŸš€',
      'STRONG_DUMP': 'â¬‡ï¸',
      'NEAR_ATH': 'ğŸ”¥',
      'NEAR_ATL': 'â„ï¸',
      'QUANTUM_SIGNAL': 'âš›ï¸',
      'WYCKOFF_ACCUMULATION': 'ğŸ¯',
      'MULTI_STRATEGY_CONSENSUS': 'ğŸŒŸ'
    };

    const importanceColors = {
      'CRITICAL': 'ğŸ”´',
      'HIGH': 'ğŸŸ ',
      'MEDIUM': 'ğŸŸ¡'
    };

    topEvents.forEach((event, index) => {
      const icon = typeIcons[event.type] || 'ğŸ“Š';
      const impIcon = importanceColors[event.importance] || 'âšª';
      const medal = ['1ï¸âƒ£', '2ï¸âƒ£', '3ï¸âƒ£', '4ï¸âƒ£', '5ï¸âƒ£', '6ï¸âƒ£', '7ï¸âƒ£'][index];

      message += `${medal} ${icon} <b>${event.symbol}</b>\n`;
      message += `${impIcon} ${event.importance} (Score: ${event.score.toFixed(0)})\n`;

      if (event.data.price) {
        message += `ğŸ’° Price: $${typeof event.data.price === 'number' ? event.data.price.toFixed(event.data.price < 1 ? 6 : 2) : event.data.price}\n`;
      }

      if (event.data.change24h !== undefined) {
        const changeEmoji = event.data.change24h > 0 ? 'ğŸ“ˆ' : 'ğŸ“‰';
        message += `${changeEmoji} 24h: ${event.data.change24h > 0 ? '+' : ''}${event.data.change24h.toFixed(2)}%\n`;
      }

      if (event.data.confidence) {
        message += `ğŸ“Š Confidence: ${event.data.confidence}%\n`;
      }

      if (event.data.quantumScore) {
        message += `ğŸ”¬ Quantum: ${event.data.quantumScore}/100\n`;
      }

      if (event.data.buySignals) {
        message += `ğŸ“ˆ Buy Signals: ${event.data.buySignals}\n`;
      }

      message += `ğŸ’¡ ${event.data.reason}\n\n`;
    });

    // Ã–ZET
    message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
    message += `ğŸ“Š <b>Toplam:</b> ${criticalEvents.length} kritik olay tespit edildi\n`;
    message += `â­ <b>GÃ¶sterilen:</b> Top ${topEvents.length}\n`;
    message += `ğŸ¯ <b>Tarama:</b> Global market + 6 strateji\n`;
    message += `â° <b>SÄ±klÄ±k:</b> Her 30 dakikada\n\n`;
    message += 'âš ï¸ <b>NOT:</b> YÃ¼ksek Ã¶nem dereceli sinyaller\n';
    message += 'ğŸ’¼ HÄ±zlÄ± karar vermeniz gerekebilir';

    if (!message || message.trim().length === 0) {
      console.log('[Scheduler] âš ï¸  Mesaj iÃ§eriÄŸi boÅŸ');
      return;
    }

    await sendTelegramMessage(message);
    console.log(`[Scheduler] âœ… ${topEvents.length} CRITICAL MARKET EVENT gÃ¶nderildi`);

  } catch (error) {
    console.error('[Scheduler] âŒ Critical Market Events hatasÄ±:', error.message);
  }
}

// ğŸ“Š SAATLÄ°K BTC-ETH HIZLI ANALÄ°Z (Her saat baÅŸÄ±)
async function sendHourlyBTCETHAnalysis() {
  try {
    console.log('\n[Scheduler] ğŸ” Saatlik BTC-ETH Analizi hazÄ±rlanÄ±yor...');

    // Binance'den BTC ve ETH verilerini Ã§ek
    const [btcData, ethData] = await Promise.all([
      fetch('https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=BTCUSDT').then(r => r.json()),
      fetch('https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=ETHUSDT').then(r => r.json())
    ]);

    const btcPrice = parseFloat(btcData.lastPrice);
    const btcChange = parseFloat(btcData.priceChangePercent);
    const ethPrice = parseFloat(ethData.lastPrice);
    const ethChange = parseFloat(ethData.priceChangePercent);

    // Trend analizi
    const getTrend = (change) => {
      if (change > 1) return { emoji: 'â†—ï¸', text: 'GÃ¼Ã§lÃ¼ YÃ¼kseliÅŸ' };
      if (change > 0.3) return { emoji: 'â†—ï¸', text: 'Hafif YÃ¼kseliÅŸ' };
      if (change < -1) return { emoji: 'â†˜ï¸', text: 'GÃ¼Ã§lÃ¼ DÃ¼ÅŸÃ¼ÅŸ' };
      if (change < -0.3) return { emoji: 'â†˜ï¸', text: 'Hafif DÃ¼ÅŸÃ¼ÅŸ' };
      return { emoji: 'â¡ï¸', text: 'Yatay' };
    };

    const getMomentum = (change) => {
      const absChange = Math.abs(change);
      if (absChange > 2) return 'Ã‡ok GÃ¼Ã§lÃ¼';
      if (absChange > 1) return 'GÃ¼Ã§lÃ¼';
      if (absChange > 0.5) return 'Orta';
      return 'ZayÄ±f';
    };

    const btcTrend = getTrend(btcChange);
    const ethTrend = getTrend(ethChange);
    const btcMomentum = getMomentum(btcChange);
    const ethMomentum = getMomentum(ethChange);

    // Ã–zet yorum
    let summary = '';
    if (btcChange > 1 && ethChange > 1) {
      summary = 'BTC ve ETH gÃ¼Ã§lÃ¼ yÃ¼kseliÅŸte. Genel piyasa pozitif.';
    } else if (btcChange < -1 && ethChange < -1) {
      summary = 'BTC ve ETH gÃ¼Ã§lÃ¼ dÃ¼ÅŸÃ¼ÅŸte. Genel piyasa negatif.';
    } else if (btcChange > 1) {
      summary = 'BTC gÃ¼Ã§lÃ¼ yÃ¼kseliÅŸte, ETH daha yavaÅŸ. BTC dominansÄ± artÄ±yor.';
    } else if (ethChange > 1) {
      summary = 'ETH gÃ¼Ã§lÃ¼ yÃ¼kseliÅŸte, BTC daha yavaÅŸ. Altcoin momentum var.';
    } else {
      summary = 'BTC ve ETH yatay seyrediyor. Piyasa dengeli.';
    }

    const now = new Date();
    const dateStr = now.toLocaleDateString('tr-TR', { day: '2-digit', month: 'short', year: 'numeric' });
    const timeStr = now.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit', hour12: false });

    let message = 'â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n';
    message += 'â•‘  â° SAATLÄ°K PÄ°YASA RAPORU  â•‘\n';
    message += 'â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£\n';
    message += `â•‘  ğŸ“… ${dateStr} - ${timeStr} UTC\n`;
    message += 'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';

    message += 'ğŸ”¶ <b>BITCOIN (BTC)</b>\n';
    message += `ğŸ’° Fiyat: <b>$${btcPrice.toLocaleString('en-US')}</b>\n`;
    message += `ğŸ“Š 1 Saatlik: ${btcChange >= 0 ? '+' : ''}${btcChange.toFixed(2)}% ${btcTrend.emoji}\n`;
    message += `ğŸ“ˆ Trend: ${btcTrend.text}\n`;
    message += `âš¡ Momentum: ${btcMomentum}\n\n`;

    message += 'ğŸ”· <b>ETHEREUM (ETH)</b>\n';
    message += `ğŸ’° Fiyat: <b>$${ethPrice.toLocaleString('en-US')}</b>\n`;
    message += `ğŸ“Š 1 Saatlik: ${ethChange >= 0 ? '+' : ''}${ethChange.toFixed(2)}% ${ethTrend.emoji}\n`;
    message += `ğŸ“ˆ Trend: ${ethTrend.text}\n`;
    message += `âš¡ Momentum: ${ethMomentum}\n\n`;

    message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';
    message += 'ğŸ’¡ <b>Ã–ZET</b>\n';
    message += `${summary}\n\n`;

    message += 'âš ï¸ <i>Bu bilgiler yalnÄ±zca bilgilendirme amaÃ§lÄ±dÄ±r.</i>';

    await sendTelegramMessage(message);
    console.log('[Scheduler] âœ… Saatlik BTC-ETH analizi gÃ¶nderildi');

  } catch (error) {
    console.error('[Scheduler] âŒ Saatlik BTC-ETH analizi hatasÄ±:', error.message);
  }
}

// ğŸ“ˆ 4 SAATLÄ°K DETAYLI MARKET RAPORU (00:00, 04:00, 08:00, 12:00, 16:00, 20:00 UTC)
async function send4HourlyMarketReport() {
  try {
    console.log('\n[Scheduler] ğŸ“Š 4 Saatlik DetaylÄ± Market Raporu hazÄ±rlanÄ±yor...');

    // TÃ¼m verileri paralel olarak Ã§ek
    const [btcData, ethData, globalData, topAltcoins] = await Promise.all([
      fetch('https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=BTCUSDT').then(r => r.json()),
      fetch('https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=ETHUSDT').then(r => r.json()),
      fetch('https://api.coingecko.com/api/v3/global').then(r => r.json()),
      fetch('https://fapi.binance.com/fapi/v1/ticker/24hr').then(r => r.json())
    ]);

    // BTC Analizi
    const btcPrice = parseFloat(btcData.lastPrice);
    const btcChange24h = parseFloat(btcData.priceChangePercent);
    const btcHigh = parseFloat(btcData.highPrice);
    const btcLow = parseFloat(btcData.lowPrice);

    // ETH Analizi
    const ethPrice = parseFloat(ethData.lastPrice);
    const ethChange24h = parseFloat(ethData.priceChangePercent);
    const ethHigh = parseFloat(ethData.highPrice);
    const ethLow = parseFloat(ethData.lowPrice);

    // Market Cap verileri
    const totalMarketCap = globalData.data.total_market_cap.usd;
    const btcDominance = globalData.data.market_cap_percentage.btc;
    const ethDominance = globalData.data.market_cap_percentage.eth;

    // Top 10 altcoin ortalama deÄŸiÅŸimi (BTC ve ETH hariÃ§)
    const top10Altcoins = topAltcoins
      .filter(coin => !['BTCUSDT', 'ETHUSDT', 'USDTUSDT', 'BUSDUSDT'].includes(coin.symbol))
      .sort((a, b) => parseFloat(b.quoteVolume) - parseFloat(a.quoteVolume))
      .slice(0, 10);

    const altcoinAvgChange = top10Altcoins.reduce((sum, coin) => sum + parseFloat(coin.priceChangePercent), 0) / top10Altcoins.length;

    // Altcoin GÃ¼ven Endeksi Hesaplama
    const altcoinConfidenceIndex = Math.min(100, Math.max(0,
      (100 - btcDominance) * 0.6 +
      ethDominance * 0.4 +
      (altcoinAvgChange > 0 ? altcoinAvgChange : 0) * 0.3
    ));

    // Trend ve analiz fonksiyonlarÄ±
    const getTrendAnalysis = (change) => {
      if (change > 3) return { emoji: 'ğŸš€', text: 'GÃ¼Ã§lÃ¼ YÃ¼kseliÅŸ', color: 'green' };
      if (change > 1) return { emoji: 'â†—ï¸', text: 'Orta YÃ¼kseliÅŸ', color: 'lightgreen' };
      if (change < -3) return { emoji: 'ğŸ“‰', text: 'GÃ¼Ã§lÃ¼ DÃ¼ÅŸÃ¼ÅŸ', color: 'red' };
      if (change < -1) return { emoji: 'â†˜ï¸', text: 'Orta DÃ¼ÅŸÃ¼ÅŸ', color: 'orange' };
      return { emoji: 'â¡ï¸', text: 'Yatay', color: 'gray' };
    };

    // RSI tahmini (basitleÅŸtirilmiÅŸ)
    const estimateRSI = (change24h) => {
      const rsi = 50 + (change24h * 2);
      return Math.min(100, Math.max(0, rsi));
    };

    const btcRSI = estimateRSI(btcChange24h);
    const ethRSI = estimateRSI(ethChange24h);

    const getRSIStatus = (rsi) => {
      if (rsi > 70) return 'AÅŸÄ±rÄ± AlÄ±m';
      if (rsi > 60) return 'NÃ¶tr-AÅŸÄ±rÄ± AlÄ±m YakÄ±n';
      if (rsi < 30) return 'AÅŸÄ±rÄ± SatÄ±m';
      if (rsi < 40) return 'NÃ¶tr-AÅŸÄ±rÄ± SatÄ±m YakÄ±n';
      return 'NÃ¶tr';
    };

    const btcTrend = getTrendAnalysis(btcChange24h);
    const ethTrend = getTrendAnalysis(ethChange24h);

    // Destek-DirenÃ§ seviyeleri (basitleÅŸtirilmiÅŸ)
    const btcSupport = (btcLow * 1.002).toFixed(0);
    const btcResistance = (btcHigh * 0.998).toFixed(0);
    const ethSupport = (ethLow * 1.002).toFixed(2);
    const ethResistance = (ethHigh * 0.998).toFixed(2);

    // BTC-ETH korelasyon tahmini
    const correlation = Math.abs(btcChange24h - ethChange24h) < 2 ? 0.85 : 0.65;

    // Altcoin endeks durumu
    const getAltcoinStatus = (index) => {
      if (index > 70) return { emoji: 'ğŸš€', text: 'YÃœKSEK', desc: 'GÃ¼Ã§lÃ¼ altcoin momentum' };
      if (index > 50) return { emoji: 'ğŸ“ˆ', text: 'ORTA-YÃœKSEK', desc: 'Altcoin piyasasÄ± gÃ¼Ã§leniyor' };
      if (index > 30) return { emoji: 'â¡ï¸', text: 'ORTA', desc: 'Dengeli piyasa' };
      return { emoji: 'ğŸ“‰', text: 'DÃœÅÃœK', desc: 'BTC dominansÄ± yÃ¼ksek' };
    };

    const altcoinStatus = getAltcoinStatus(altcoinConfidenceIndex);

    const now = new Date();
    const dateStr = now.toLocaleDateString('tr-TR', { day: '2-digit', month: 'short', year: 'numeric' });
    const timeStr = now.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit', hour12: false });

    let message = 'â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n';
    message += 'â•‘  ğŸ“Š 4 SAATLÄ°K PÄ°YASA ANALÄ°ZÄ°  â•‘\n';
    message += 'â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£\n';
    message += `â•‘  ğŸ“… ${dateStr} - ${timeStr} UTC\n`;
    message += 'â•‘  â° 4h KapanÄ±ÅŸ Raporu\n';
    message += 'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';

    message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';
    message += 'ğŸ”¶ <b>BITCOIN ANALÄ°ZÄ°</b>\n\n';
    message += `ğŸ’° Fiyat: <b>$${btcPrice.toLocaleString('en-US')}</b>\n`;
    message += `ğŸ“ˆ 24 Saatlik: ${btcChange24h >= 0 ? '+' : ''}${btcChange24h.toFixed(2)}% ${btcTrend.emoji}\n\n`;
    message += `ğŸ¯ Trend: <b>${btcTrend.text}</b>\n`;
    message += `ğŸ“ Destek: $${btcSupport}\n`;
    message += `ğŸ“ DirenÃ§: $${btcResistance}\n\n`;
    message += `ğŸ“‰ RSI (24h): ${btcRSI.toFixed(0)} (${getRSIStatus(btcRSI)})\n`;
    message += `ğŸ“Š MACD: ${btcChange24h > 0 ? 'Pozitif KesiÅŸim âœ…' : 'Negatif âš ï¸'}\n\n`;
    message += `ğŸ’¡ <i>Yorum: BTC ${btcTrend.text.toLowerCase()} trendinde,`;
    message += ` $${btcResistance} direncini ${btcChange24h > 0 ? 'test ediyor' : 'izliyor'}.</i>\n\n`;

    message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';
    message += 'ğŸ”· <b>ETHEREUM ANALÄ°ZÄ°</b>\n\n';
    message += `ğŸ’° Fiyat: <b>$${ethPrice.toLocaleString('en-US')}</b>\n`;
    message += `ğŸ“ˆ 24 Saatlik: ${ethChange24h >= 0 ? '+' : ''}${ethChange24h.toFixed(2)}% ${ethTrend.emoji}\n\n`;
    message += `ğŸ¯ Trend: <b>${ethTrend.text}</b>\n`;
    message += `ğŸ“ Destek: $${ethSupport}\n`;
    message += `ğŸ“ DirenÃ§: $${ethResistance}\n\n`;
    message += `ğŸ“‰ RSI (24h): ${ethRSI.toFixed(0)} (${getRSIStatus(ethRSI)})\n`;
    message += `ğŸ“Š MACD: ${ethChange24h > 0 ? 'Pozitif âœ…' : 'Negatif âš ï¸'}\n\n`;
    message += `ğŸ”— BTC Korelasyon: ${correlation.toFixed(2)} (${correlation > 0.8 ? 'YÃ¼ksek' : 'Orta'})\n\n`;

    message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';
    message += 'ğŸŒ <b>GLOBAL PÄ°YASA</b>\n\n';
    message += `ğŸ’ Total Market Cap: <b>$${(totalMarketCap / 1e12).toFixed(2)}T</b>\n`;
    message += `ğŸ“ˆ 24h DeÄŸiÅŸim: ${((btcChange24h * btcDominance + ethChange24h * ethDominance) / 100).toFixed(2)}%\n\n`;
    message += `ğŸ”¶ BTC Dominance: ${btcDominance.toFixed(1)}%\n`;
    message += `ğŸ”· ETH Dominance: ${ethDominance.toFixed(1)}%\n\n`;

    message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';
    message += 'ğŸ¯ <b>ALTCOIN GÃœVEN ENDEKSÄ°</b>\n\n';
    message += `ğŸ“Š Skor: <b>${altcoinConfidenceIndex.toFixed(0)}/100</b> ${altcoinStatus.emoji}\n`;
    message += `ğŸ“ˆ Durum: <b>${altcoinStatus.text}</b>\n\n`;
    message += `ğŸ’¡ <b>AÃ§Ä±klama:</b>\n`;
    message += `${altcoinStatus.desc}. `;

    if (altcoinConfidenceIndex > 60) {
      message += `BTC dominance azalÄ±rken, ETH ve major altcoinler momentum kazanÄ±yor. Dikkatli altcoin pozisyonlarÄ± iÃ§in uygun ortam.`;
    } else if (altcoinConfidenceIndex < 40) {
      message += `BTC dominansÄ± yÃ¼ksek. Altcoin piyasasÄ± zayÄ±f, BTC odaklÄ± stratejiler Ã¶n planda.`;
    } else {
      message += `Piyasa dengeli. SeÃ§ici altcoin pozisyonlarÄ± deÄŸerlendirilebilir.`;
    }

    message += `\n\nTop 10 Altcoin Ort: ${altcoinAvgChange >= 0 ? '+' : ''}${altcoinAvgChange.toFixed(2)}%\n\n`;

    message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';
    message += 'âš ï¸ <b>UYARI</b>\n';
    message += 'â€¢ Bu bilgiler yalnÄ±zca bilgilendirme amaÃ§lÄ±dÄ±r\n';
    message += 'â€¢ YatÄ±rÄ±m kararlarÄ± kiÅŸiseldir\n';
    message += 'â€¢ Risk yÃ¶netimini unutmayÄ±n';

    await sendTelegramMessage(message);
    console.log('[Scheduler] âœ… 4 Saatlik detaylÄ± market raporu gÃ¶nderildi');

  } catch (error) {
    console.error('[Scheduler] âŒ 4 Saatlik market raporu hatasÄ±:', error.message);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“Š TA-LIB ENTEGRASYON FONKSÄ°YONLARI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


// TA-Lib analizi Next.js API Ã¼zerinden al (strategy-analysis endpoint)
async function getTALibAnalysis(symbol, interval = '1h') {
  try {
    const url = `${BASE_URL}/api/strategy-analysis/${symbol}`;
    const response = await httpGet(url);

    if (!response || !response.success || !response.data || !response.data.strategies) {
      console.error(`[TA-Lib] ${symbol} veri alÄ±namadÄ±`);
      return { error: true, symbol };
    }

    // TA-Lib stratejisini bul
    const talibStrategy = response.data.strategies.find(s =>
      s.name && s.name.toLowerCase().includes('ta-lib')
    );

    if (!talibStrategy) {
      console.log(`[TA-Lib] ${symbol} iÃ§in TA-Lib stratejisi bulunamadÄ±`);
      // Fallback: en yÃ¼ksek confidence'a sahip stratejiyi kullan
      const topStrategy = response.data.strategies.reduce((prev, current) =>
        (prev.confidence > current.confidence) ? prev : current
      );
      return {
        signal: topStrategy.signal,
        confidence: topStrategy.confidence,
        reason: topStrategy.reason || 'KapsamlÄ± teknik analiz',
        strategyName: topStrategy.name,
        symbol
      };
    }

    // TA-Lib stratejisi bulundu
    return {
      signal: talibStrategy.signal,
      confidence: talibStrategy.confidence,
      reason: talibStrategy.reason || '158 indikatÃ¶r analizi',
      strategyName: talibStrategy.name,
      symbol,
      // API'den gelen ekstra veriler
      rsi: talibStrategy.data?.rsi,
      macd: talibStrategy.data?.macd,
      bbands: talibStrategy.data?.bbands
    };

  } catch (error) {
    console.error(`[TA-Lib] ${symbol} analiz hatasÄ±:`, error.message);
    return { error: true, symbol };
  }
}

// 1ï¸âƒ£ SAATLÄ°K TA-LIB SÄ°NYALLERÄ° - DEVRE DIÅI BIRAKILDI
/*
async function sendTALibHourlySignals() {
  try {
    console.log('[TA-Lib] ğŸ“Š Saatlik TA-Lib sinyalleri hazÄ±rlanÄ±yor...');

    // Dinamik coin seÃ§imi - Balanced strateji (top volume + momentum karÄ±ÅŸÄ±mÄ±)
    const symbols = await getSmartCoinSelection(4, 'balanced');
    let message = 'ğŸ“Š <b>TA-LIB SAATLÄ°K SÄ°NYALLER</b>\n\n';
    message += `ğŸ• Zaman: ${new Date().toLocaleString('tr-TR')}\n`;
    message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';

    for (const symbol of symbols) {
      const analysis = await getTALibAnalysis(symbol, '1h');
      if (!analysis || analysis.error) {
        message += `âŒ ${symbol}: Veri alÄ±namadÄ±\n\n`;
        continue;
      }

      message += `<b>${symbol}</b>\n`;
      message += `â€¢ Sinyal: ${analysis.signal || 'NEUTRAL'}\n`;
      message += `â€¢ GÃ¼ven: %${analysis.confidence || 0}\n`;
      message += `â€¢ Strateji: ${analysis.strategyName || 'TA-Lib'}\n`;
      if (analysis.reason) {
        message += `â€¢ Neden: ${analysis.reason.substring(0, 50)}...\n`;
      }
      // Ä°ndikatÃ¶rler varsa gÃ¶ster (opsiyonel)
      if (analysis.rsi) message += `â€¢ RSI: ${analysis.rsi.toFixed(2)}\n`;
      if (analysis.macd?.histogram) message += `â€¢ MACD: ${analysis.macd.histogram.toFixed(4)}\n`;
      if (analysis.bbands?.position) message += `â€¢ BB: ${analysis.bbands.position}\n`;
      message += `\n`;
    }

    message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';
    message += 'âš ï¸ <b>UYARI</b>\n';
    message += 'â€¢ Bu bilgiler yalnÄ±zca bilgilendirme amaÃ§lÄ±dÄ±r\n';
    message += 'â€¢ YatÄ±rÄ±m kararlarÄ± kiÅŸiseldir\n';
    message += 'â€¢ Risk yÃ¶netimini unutmayÄ±n';

    await sendTelegramMessage(message);
    console.log('[TA-Lib] âœ… Saatlik TA-Lib sinyalleri gÃ¶nderildi');

  } catch (error) {
    console.error('[TA-Lib] âŒ Saatlik sinyal hatasÄ±:', error.message);
  }
}
*/

// 2ï¸âƒ£ 4 SAATLÄ°K TA-LIB SÄ°NYALLERÄ°
async function sendTALib4HourlySignals() {
  try {
    console.log('[TA-Lib] ğŸ“Š 4 Saatlik TA-Lib sinyalleri hazÄ±rlanÄ±yor...');

    // Dinamik coin seÃ§imi - Rotasyon sistemi (her seferinde farklÄ± coinler)
    const symbols = await getRotatedCoins(6);
    let message = 'ğŸ“Š <b>TA-LIB 4 SAATLÄ°K DETAYLI ANALÄ°Z</b>\n\n';
    message += `ğŸ•“ Zaman: ${new Date().toLocaleString('tr-TR')}\n`;
    message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';

    for (const symbol of symbols) {
      const analysis = await getTALibAnalysis(symbol, '4h');
      if (!analysis || analysis.error) {
        message += `âŒ ${symbol}: Veri alÄ±namadÄ±\n\n`;
        continue;
      }

      message += `<b>${symbol}</b>\n`;
      message += `â€¢ RSI: ${analysis.rsi?.toFixed(2) || 'N/A'}\n`;
      message += `â€¢ MACD: ${analysis.macd?.histogram?.toFixed(4) || 'N/A'}\n`;
      message += `â€¢ EMA20/50: ${analysis.ema?.trend || 'N/A'}\n`;
      message += `â€¢ BB Pozisyon: ${analysis.bbands?.position || 'N/A'}\n`;
      message += `â€¢ Trend: ${analysis.trend || 'N/A'}\n`;
      message += `â€¢ Sinyal: <b>${analysis.signal || 'NÃ–TR'}</b>\n\n`;
    }

    message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';
    message += 'âš ï¸ <b>UYARI</b>\n';
    message += 'â€¢ Bu bilgiler yalnÄ±zca bilgilendirme amaÃ§lÄ±dÄ±r\n';
    message += 'â€¢ YatÄ±rÄ±m kararlarÄ± kiÅŸiseldir\n';
    message += 'â€¢ Risk yÃ¶netimini unutmayÄ±n';

    await sendTelegramMessage(message);
    console.log('[TA-Lib] âœ… 4 Saatlik TA-Lib sinyalleri gÃ¶nderildi');

  } catch (error) {
    console.error('[TA-Lib] âŒ 4 Saatlik sinyal hatasÄ±:', error.message);
  }
}

// 3ï¸âƒ£ GÃœNLÃœK TA-LIB SÄ°NYALLERÄ°
async function sendTALibDailySignals() {
  try {
    console.log('[TA-Lib] ğŸ“Š GÃ¼nlÃ¼k TA-Lib sinyalleri hazÄ±rlanÄ±yor...');

    // Dinamik coin seÃ§imi - En yÃ¼ksek volume'lÃ¼ 8 coin
    const symbols = await getSmartCoinSelection(8, 'volume');
    let message = 'ğŸ“Š <b>TA-LIB GÃœNLÃœK KAPSAMLI ANALÄ°Z</b>\n\n';
    message += `ğŸ“… Tarih: ${new Date().toLocaleDateString('tr-TR')}\n`;
    message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';

    for (const symbol of symbols) {
      const analysis = await getTALibAnalysis(symbol, '1d');
      if (!analysis || analysis.error) {
        message += `âŒ ${symbol}: Veri alÄ±namadÄ±\n\n`;
        continue;
      }

      message += `<b>${symbol}</b>\n`;
      message += `â€¢ RSI: ${analysis.rsi?.toFixed(2) || 'N/A'}\n`;
      message += `â€¢ MACD: ${analysis.macd?.histogram?.toFixed(4) || 'N/A'}\n`;
      message += `â€¢ EMA20/50/200: ${analysis.ema?.trend || 'N/A'}\n`;
      message += `â€¢ BB Width: ${analysis.bbands?.width || 'N/A'}\n`;
      message += `â€¢ ADX: ${analysis.adx?.toFixed(2) || 'N/A'}\n`;
      message += `â€¢ Trend GÃ¼cÃ¼: ${analysis.trendStrength || 'N/A'}\n`;
      message += `â€¢ Sinyal: <b>${analysis.signal || 'NÃ–TR'}</b>\n\n`;
    }

    message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';
    message += 'âš ï¸ <b>UYARI</b>\n';
    message += 'â€¢ Bu bilgiler yalnÄ±zca bilgilendirme amaÃ§lÄ±dÄ±r\n';
    message += 'â€¢ YatÄ±rÄ±m kararlarÄ± kiÅŸiseldir\n';
    message += 'â€¢ Risk yÃ¶netimini unutmayÄ±n';

    await sendTelegramMessage(message);
    console.log('[TA-Lib] âœ… GÃ¼nlÃ¼k TA-Lib sinyalleri gÃ¶nderildi');

  } catch (error) {
    console.error('[TA-Lib] âŒ GÃ¼nlÃ¼k sinyal hatasÄ±:', error.message);
  }
}

// 4ï¸âƒ£ MUHAFAZAKAR ALIM SÄ°NYALLERÄ° (SAATLÄ°K)
async function sendConservativeSignals() {
  try {
    console.log('[Conservative] ğŸ›¡ï¸ Muhafazakar alÄ±m sinyalleri hazÄ±rlanÄ±yor...');

    const url = `${BASE_URL}/api/conservative-signals`;
    const response = await httpGet(url);

    if (!response || !response.success || !response.data || !response.data.signals) {
      console.error('[Conservative] âŒ Conservative signals API hatasÄ±');
      return;
    }

    const signals = response.data.signals.filter(s => s.signal === 'BUY').slice(0, 5); // En iyi 5 BUY sinyali

    if (signals.length === 0) {
      console.log('[Conservative] âš ï¸ Muhafazakar alÄ±m sinyali bulunamadÄ±');
      return;
    }

    let message = 'ğŸ›¡ï¸ <b>MUHAFAZAKAR ALIM SÄ°NYALLERÄ°</b>\n\n';
    message += `ğŸ• Zaman: ${new Date().toLocaleString('tr-TR')}\n`;
    message += `ğŸ“Š Toplam Sinyal: ${signals.length}\n`;
    message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';

    message += 'ğŸ’¡ <i>SÄ±kÄ± kriterler: RSI oversold, volume artÄ±ÅŸÄ±, destek seviyesi</i>\n\n';

    for (const signal of signals) {
      message += `<b>${signal.symbol}</b>\n`;
      message += `ğŸ’µ Fiyat: $${signal.price?.toFixed(4) || 'N/A'}\n`;
      message += `ğŸ“ˆ 24h DeÄŸiÅŸim: ${signal.changePercent24h > 0 ? '+' : ''}${signal.changePercent24h?.toFixed(2) || 0}%\n`;
      message += `âœ… GÃ¼ven: %${signal.confidence || 0}\n`;
      message += `ğŸ“Œ Neden: ${signal.reason?.substring(0, 80) || 'N/A'}...\n\n`;

      // Ä°ndikatÃ¶rler
      if (signal.indicators) {
        message += `ğŸ“Š <b>Ä°ndikatÃ¶rler:</b>\n`;
        message += `â€¢ RSI: ${signal.indicators.rsi?.toFixed(2) || 'N/A'}\n`;
        message += `â€¢ MACD: ${signal.indicators.macd?.toFixed(4) || 'N/A'}\n`;
        message += `â€¢ Volume Ratio: ${signal.indicators.volumeRatio?.toFixed(2) || 'N/A'}x\n\n`;
      }

      // Hedefler ve Stop Loss
      if (signal.targets && signal.targets.length > 0) {
        message += `ğŸ¯ <b>Hedefler:</b>\n`;
        message += `â€¢ Hedef 1: $${signal.targets[0]?.toFixed(4) || 'N/A'} (+${(((signal.targets[0] - signal.price) / signal.price) * 100).toFixed(2)}%)\n`;
        if (signal.targets[1]) {
          message += `â€¢ Hedef 2: $${signal.targets[1]?.toFixed(4)} (+${(((signal.targets[1] - signal.price) / signal.price) * 100).toFixed(2)}%)\n`;
        }
      }

      if (signal.stopLoss) {
        message += `ğŸ›‘ Stop Loss: $${signal.stopLoss?.toFixed(4)} (${(((signal.stopLoss - signal.price) / signal.price) * 100).toFixed(2)}%)\n`;
      }

      message += '\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';
    }

    message += 'âš ï¸ <b>UYARI</b>\n';
    message += 'â€¢ Bu bilgiler yalnÄ±zca bilgilendirme amaÃ§lÄ±dÄ±r\n';
    message += 'â€¢ YatÄ±rÄ±m kararlarÄ± kiÅŸiseldir\n';
    message += 'â€¢ Risk yÃ¶netimini unutmayÄ±n\n';
    message += 'â€¢ Her zaman stop loss kullanÄ±n';

    await sendTelegramMessage(message);
    console.log('[Conservative] âœ… Muhafazakar alÄ±m sinyalleri gÃ¶nderildi');

  } catch (error) {
    console.error('[Conservative] âŒ Muhafazakar sinyal hatasÄ±:', error.message);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸŒ DÃœNYA BORSALARI PRE-MARKET ANALÄ°Z FONKSÄ°YONLARI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ğŸ‡¯ğŸ‡µ TOKYO PRE-MARKET (23:45 UTC - Tokyo aÃ§Ä±lÄ±ÅŸÄ±ndan 15 dk Ã¶nce)
async function sendTokyoPreMarket() {
  try {
    console.log('[Tokyo] ğŸ‡¯ğŸ‡µ Tokyo Pre-Market analizi hazÄ±rlanÄ±yor...');

    const btcData = await httpGet(`${BASE_URL}/api/binance/futures`);
    const btcPrice = btcData?.data?.all?.find(c => c.symbol === 'BTCUSDT');
    const ethPrice = btcData?.data?.all?.find(c => c.symbol === 'ETHUSDT');

    let message = 'ğŸ‡¯ğŸ‡µ <b>TOKYO SEANS Ã–NCESÄ° ANALÄ°Z</b>\n\n';
    message += `ğŸ• Zaman: ${new Date().toLocaleString('tr-TR')}\n`;
    message += `ğŸ“ Tokyo Stock Exchange aÃ§Ä±lÄ±ÅŸÄ±na 15 dakika\n\n`;
    message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';

    message += '<b>ğŸ“Š BTC/ETH Durum</b>\n';
    message += `BTC: $${btcPrice?.price || 'N/A'} (24h: ${btcPrice?.changePercent24h || 'N/A'}%)\n`;
    message += `ETH: $${ethPrice?.price || 'N/A'} (24h: ${ethPrice?.changePercent24h || 'N/A'}%)\n\n`;

    message += '<b>ğŸŒ Asya PiyasasÄ± Sentiment</b>\n';
    const avgChange = parseFloat(btcPrice?.changePercent24h || 0);
    if (avgChange > 2) {
      message += 'âœ… Pozitif: Kripto piyasasÄ± Tokyo aÃ§Ä±lÄ±ÅŸÄ± iÃ§in gÃ¼Ã§lÃ¼\n';
    } else if (avgChange < -2) {
      message += 'âš ï¸ Negatif: Risk-off modunda, dikkatli yaklaÅŸÄ±m\n';
    } else {
      message += 'â– NÃ¶tr: Konsolide hareket, yÃ¶n bekliyor\n';
    }

    message += '\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';
    message += 'âš ï¸ <b>UYARI</b>\n';
    message += 'â€¢ Bu bilgiler yalnÄ±zca bilgilendirme amaÃ§lÄ±dÄ±r\n';
    message += 'â€¢ YatÄ±rÄ±m kararlarÄ± kiÅŸiseldir\n';
    message += 'â€¢ Risk yÃ¶netimini unutmayÄ±n';

    await sendTelegramMessage(message);
    console.log('[Tokyo] âœ… Tokyo Pre-Market analizi gÃ¶nderildi');

  } catch (error) {
    console.error('[Tokyo] âŒ Tokyo Pre-Market hatasÄ±:', error.message);
  }
}

// ğŸ‡¨ğŸ‡³ HONG KONG/SHANGHAI PRE-MARKET (01:15 UTC)
async function sendChinaPreMarket() {
  try {
    console.log('[China] ğŸ‡¨ğŸ‡³ Hong Kong/Shanghai Pre-Market analizi hazÄ±rlanÄ±yor...');

    const btcData = await httpGet(`${BASE_URL}/api/binance/futures`);
    const btcPrice = btcData?.data?.all?.find(c => c.symbol === 'BTCUSDT');
    const ethPrice = btcData?.data?.all?.find(c => c.symbol === 'ETHUSDT');
    const globalData = await httpGet('https://api.coingecko.com/api/v3/global');

    let message = 'ğŸ‡¨ğŸ‡³ <b>HONG KONG/SHANGHAI SEANS Ã–NCESÄ°</b>\n\n';
    message += `ğŸ• Zaman: ${new Date().toLocaleString('tr-TR')}\n`;
    message += `ğŸ“ HK/Shanghai aÃ§Ä±lÄ±ÅŸÄ±na 15 dakika\n\n`;
    message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';

    message += '<b>ğŸ“Š BTC/ETH 4H Analiz</b>\n';
    message += `BTC: $${btcPrice?.price || 'N/A'} (24h: ${btcPrice?.changePercent24h || 'N/A'}%)\n`;
    message += `ETH: $${ethPrice?.price || 'N/A'} (24h: ${ethPrice?.changePercent24h || 'N/A'}%)\n\n`;

    const totalMC = globalData?.data?.total_market_cap?.usd || 0;
    const btcDom = globalData?.data?.market_cap_percentage?.btc || 0;

    message += '<b>ğŸ’° Market Cap Durumu</b>\n';
    message += `Total: $${(totalMC / 1e12).toFixed(2)}T\n`;
    message += `BTC Dominance: ${btcDom.toFixed(2)}%\n\n`;

    message += '<b>ğŸ‡¨ğŸ‡³ Ã‡in PiyasasÄ± Etkisi</b>\n';
    if (btcDom > 55) {
      message += 'âš ï¸ BTC dominansÄ± yÃ¼ksek, altcoin riski\n';
    } else {
      message += 'âœ… Altcoin season potansiyeli var\n';
    }

    message += '\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';
    message += 'âš ï¸ <b>UYARI</b>\n';
    message += 'â€¢ Bu bilgiler yalnÄ±zca bilgilendirme amaÃ§lÄ±dÄ±r\n';
    message += 'â€¢ YatÄ±rÄ±m kararlarÄ± kiÅŸiseldir\n';
    message += 'â€¢ Risk yÃ¶netimini unutmayÄ±n';

    await sendTelegramMessage(message);
    console.log('[China] âœ… China Pre-Market analizi gÃ¶nderildi');

  } catch (error) {
    console.error('[China] âŒ China Pre-Market hatasÄ±:', error.message);
  }
}

// ğŸ‡¬ğŸ‡§ LONDON PRE-MARKET (07:45 UTC)
async function sendLondonPreMarket() {
  try {
    console.log('[London] ğŸ‡¬ğŸ‡§ London Pre-Market analizi hazÄ±rlanÄ±yor...');

    const btcData = await httpGet(`${BASE_URL}/api/binance/futures`);
    const btcPrice = btcData?.data?.all?.find(c => c.symbol === 'BTCUSDT');
    const ethPrice = btcData?.data?.all?.find(c => c.symbol === 'ETHUSDT');

    let message = 'ğŸ‡¬ğŸ‡§ <b>LONDON SEANS Ã–NCESÄ° ANALÄ°Z</b>\n\n';
    message += `ğŸ• Zaman: ${new Date().toLocaleString('tr-TR')}\n`;
    message += `ğŸ“ London Stock Exchange aÃ§Ä±lÄ±ÅŸÄ±na 15 dakika\n\n`;
    message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';

    message += '<b>ğŸ“Š BTC/ETH GÃ¼nlÃ¼k Trend</b>\n';
    message += `BTC: $${btcPrice?.price || 'N/A'} (24h: ${btcPrice?.changePercent24h || 'N/A'}%)\n`;
    message += `ETH: $${ethPrice?.price || 'N/A'} (24h: ${ethPrice?.changePercent24h || 'N/A'}%)\n\n`;

    message += '<b>ğŸ‡ªğŸ‡º Avrupa Makro Etkisi</b>\n';
    const btcChange = parseFloat(btcPrice?.changePercent24h || 0);
    if (btcChange > 3) {
      message += 'âœ… Risk-on modu: Avrupa yatÄ±rÄ±mcÄ±larÄ± pozitif\n';
    } else if (btcChange < -3) {
      message += 'âš ï¸ Risk-off modu: DÃ¼ÅŸÃ¼ÅŸ baskÄ±sÄ± var\n';
    } else {
      message += 'â– Konsolidasyon: YÃ¶n bekleniyor\n';
    }

    message += '\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';
    message += 'âš ï¸ <b>UYARI</b>\n';
    message += 'â€¢ Bu bilgiler yalnÄ±zca bilgilendirme amaÃ§lÄ±dÄ±r\n';
    message += 'â€¢ YatÄ±rÄ±m kararlarÄ± kiÅŸiseldir\n';
    message += 'â€¢ Risk yÃ¶netimini unutmayÄ±n';

    await sendTelegramMessage(message);
    console.log('[London] âœ… London Pre-Market analizi gÃ¶nderildi');

  } catch (error) {
    console.error('[London] âŒ London Pre-Market hatasÄ±:', error.message);
  }
}

// ğŸ‡ºğŸ‡¸ NYSE PRE-MARKET â­ PREMIUM (14:15 UTC)
async function sendNYSEPreMarket() {
  try {
    console.log('[NYSE] ğŸ‡ºğŸ‡¸ NYSE Pre-Market PREMIUM analizi hazÄ±rlanÄ±yor...');

    const btcData = await httpGet(`${BASE_URL}/api/binance/futures`);
    const btcPrice = btcData?.data?.all?.find(c => c.symbol === 'BTCUSDT');
    const ethPrice = btcData?.data?.all?.find(c => c.symbol === 'ETHUSDT');
    const globalData = await httpGet('https://api.coingecko.com/api/v3/global');

    // TA-Lib analizleri
    const btcAnalysis = await getTALibAnalysis('BTCUSDT', '1h');
    const ethAnalysis = await getTALibAnalysis('ETHUSDT', '1h');

    let message = 'ğŸ‡ºğŸ‡¸ <b>NYSE PRE-MARKET PREMIUM ANALÄ°Z â­</b>\n\n';
    message += `ğŸ• Zaman: ${new Date().toLocaleString('tr-TR')}\n`;
    message += `ğŸ“ NYSE/NASDAQ aÃ§Ä±lÄ±ÅŸÄ±na 15 dakika\n\n`;
    message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';

    message += '<b>ğŸ“Š BTC TA-Lib Full Analiz</b>\n';
    message += `Fiyat: $${btcPrice?.price || 'N/A'} (24h: ${btcPrice?.changePercent24h || 'N/A'}%)\n`;
    if (btcAnalysis && !btcAnalysis.error) {
      message += `RSI: ${btcAnalysis.rsi?.toFixed(2) || 'N/A'}\n`;
      message += `MACD: ${btcAnalysis.macd?.histogram?.toFixed(4) || 'N/A'}\n`;
      message += `BB Pozisyon: ${btcAnalysis.bbands?.position || 'N/A'}\n`;
      message += `Sinyal: <b>${btcAnalysis.signal || 'NÃ–TR'}</b>\n\n`;
    } else {
      message += 'TA-Lib veri alÄ±namadÄ±\n\n';
    }

    message += '<b>ğŸ“Š ETH TA-Lib Full Analiz</b>\n';
    message += `Fiyat: $${ethPrice?.price || 'N/A'} (24h: ${ethPrice?.changePercent24h || 'N/A'}%)\n`;
    if (ethAnalysis && !ethAnalysis.error) {
      message += `RSI: ${ethAnalysis.rsi?.toFixed(2) || 'N/A'}\n`;
      message += `MACD: ${ethAnalysis.macd?.histogram?.toFixed(4) || 'N/A'}\n`;
      message += `Sinyal: <b>${ethAnalysis.signal || 'NÃ–TR'}</b>\n\n`;
    } else {
      message += 'TA-Lib veri alÄ±namadÄ±\n\n';
    }

    // Altcoin Market Cap AL/SAT AlgoritmasÄ±
    const totalMC = globalData?.data?.total_market_cap?.usd || 0;
    const btcMC = globalData?.data?.total_market_cap?.btc || 0;
    const ethMC = globalData?.data?.total_market_cap?.eth || 0;
    const btcDom = globalData?.data?.market_cap_percentage?.btc || 0;
    const ethDom = globalData?.data?.market_cap_percentage?.eth || 0;

    const altcoinMC = totalMC - (btcMC + ethMC);
    const altcoinChange = parseFloat(btcPrice?.changePercent24h || 0);

    let altcoinSignal = 'NÃ–TR';
    let altcoinConfidence = 50;

    if (altcoinChange > 5 && btcDom < 50) {
      altcoinSignal = 'STRONG BUY';
      altcoinConfidence = 85;
    } else if (altcoinChange > 2 && btcDom < 55) {
      altcoinSignal = 'BUY';
      altcoinConfidence = 70;
    } else if (altcoinChange < -5 && btcDom > 60) {
      altcoinSignal = 'STRONG SELL';
      altcoinConfidence = 80;
    } else if (altcoinChange < -2 && btcDom > 58) {
      altcoinSignal = 'SELL';
      altcoinConfidence = 65;
    }

    message += '<b>ğŸ’° Altcoin MarketCap AL/SAT</b>\n';
    message += `Total MC: $${(totalMC / 1e12).toFixed(2)}T\n`;
    message += `BTC Dom: ${btcDom.toFixed(2)}%\n`;
    message += `ETH Dom: ${ethDom.toFixed(2)}%\n`;
    message += `Sinyal: <b>${altcoinSignal}</b> (${altcoinConfidence}%)\n\n`;

    message += '<b>ğŸ“ˆ S&P 500 Korelasyon</b>\n';
    if (btcPrice?.changePercent24h > 2) {
      message += 'âœ… Risk-on: NYSE aÃ§Ä±lÄ±ÅŸÄ± pozitif etkileyebilir\n\n';
    } else {
      message += 'âš ï¸ Risk-off: Dikkatli yaklaÅŸÄ±m Ã¶nerilir\n\n';
    }

    message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';
    message += 'âš ï¸ <b>UYARI</b>\n';
    message += 'â€¢ Bu bilgiler yalnÄ±zca bilgilendirme amaÃ§lÄ±dÄ±r\n';
    message += 'â€¢ YatÄ±rÄ±m kararlarÄ± kiÅŸiseldir\n';
    message += 'â€¢ Risk yÃ¶netimini unutmayÄ±n';

    await sendTelegramMessage(message);
    console.log('[NYSE] âœ… NYSE Pre-Market PREMIUM analizi gÃ¶nderildi');

  } catch (error) {
    console.error('[NYSE] âŒ NYSE Pre-Market hatasÄ±:', error.message);
  }
}

// ğŸ‡ºğŸ‡¸ NYSE CLOSE ANALYSIS (20:45 UTC)
async function sendNYSECloseAnalysis() {
  try {
    console.log('[NYSE Close] ğŸ‡ºğŸ‡¸ NYSE Close analizi hazÄ±rlanÄ±yor...');

    const btcData = await httpGet(`${BASE_URL}/api/binance/futures`);
    const btcPrice = btcData?.data?.all?.find(c => c.symbol === 'BTCUSDT');
    const ethPrice = btcData?.data?.all?.find(c => c.symbol === 'ETHUSDT');

    let message = 'ğŸ‡ºğŸ‡¸ <b>NYSE KAPANIÅ ANALÄ°ZÄ°</b>\n\n';
    message += `ğŸ• Zaman: ${new Date().toLocaleString('tr-TR')}\n`;
    message += `ğŸ“ NYSE/NASDAQ kapanÄ±ÅŸÄ±na 15 dakika\n\n`;
    message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';

    message += '<b>ğŸ“Š GÃ¼nlÃ¼k KapanÄ±ÅŸ Projeksiyon</b>\n';
    message += `BTC: $${btcPrice?.price || 'N/A'} (24h: ${btcPrice?.changePercent24h || 'N/A'}%)\n`;
    message += `ETH: $${ethPrice?.price || 'N/A'} (24h: ${ethPrice?.changePercent24h || 'N/A'}%)\n\n`;

    message += '<b>ğŸŒ™ Overnight Risk Analizi</b>\n';
    const btcChange = parseFloat(btcPrice?.changePercent24h || 0);
    if (btcChange > 2) {
      message += 'âœ… Pozitif kapanÄ±ÅŸ beklentisi\n';
      message += 'ğŸŒ Asya seansÄ± gÃ¼Ã§lÃ¼ aÃ§Ä±labilir\n';
    } else if (btcChange < -2) {
      message += 'âš ï¸ Negatif kapanÄ±ÅŸ riski\n';
      message += 'ğŸŒ Asya seansÄ± dikkatli yaklaÅŸmalÄ±\n';
    } else {
      message += 'â– NÃ¶tr kapanÄ±ÅŸ\n';
      message += 'ğŸŒ Asya seansÄ± yÃ¶n arayacak\n';
    }

    message += '\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';
    message += 'âš ï¸ <b>UYARI</b>\n';
    message += 'â€¢ Bu bilgiler yalnÄ±zca bilgilendirme amaÃ§lÄ±dÄ±r\n';
    message += 'â€¢ YatÄ±rÄ±m kararlarÄ± kiÅŸiseldir\n';
    message += 'â€¢ Risk yÃ¶netimini unutmayÄ±n';

    await sendTelegramMessage(message);
    console.log('[NYSE Close] âœ… NYSE Close analizi gÃ¶nderildi');

  } catch (error) {
    console.error('[NYSE Close] âŒ NYSE Close hatasÄ±:', error.message);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ¯ DECISION ENGINE - OTOMATÄ°K KARAR MOTORÄ°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Saatlik BTC-ETH HÄ±zlÄ± Analiz
async function sendHourlyDecisionEngine() {
  try {
    console.log('\n[Decision Engine Hourly] ğŸ¯ Saatlik BTC-ETH Analizi...');

    const [btcDecision, ethDecision] = await Promise.all([
      httpGet(`${BASE_URL}/api/decision-engine?symbol=BTCUSDT`).catch(() => ({ data: null })),
      httpGet(`${BASE_URL}/api/decision-engine?symbol=ETHUSDT`).catch(() => ({ data: null }))
    ]);

    if (!btcDecision.data && !ethDecision.data) {
      console.log('[Decision Engine Hourly] â„¹ï¸  Veri alÄ±namadÄ±');
      return;
    }

    // Karar tÃ¼rlerini TÃ¼rkÃ§eye Ã§evir
    const translateDecision = (decision) => {
      const translations = {
        'STRONG_BUY': 'GÃœÃ‡LÃœ AL',
        'BUY': 'AL',
        'HOLD': 'BEKLE',
        'SELL': 'SAT',
        'STRONG_SELL': 'GÃœÃ‡LÃœ SAT'
      };
      return translations[decision] || decision;
    };

    let message = '<b>â° SAATLÄ°K PÄ°YASA DURUMU</b>\n\n';

    if (btcDecision.data) {
      const btc = btcDecision.data;
      const emoji = btc.decision === 'STRONG_BUY' || btc.decision === 'BUY' ? 'ğŸŸ¢' :
                    btc.decision === 'STRONG_SELL' || btc.decision === 'SELL' ? 'ğŸ”´' : 'ğŸŸ¡';
      const decisionTR = translateDecision(btc.decision);
      message += `${emoji} <b>Bitcoin</b>: ${decisionTR} (%${(btc.confidence * 100).toFixed(0)} gÃ¼ven)\n`;
      message += `   ğŸ’µ Fiyat: $${btc.currentPrice.toFixed(0)}\n\n`;
    }

    if (ethDecision.data) {
      const eth = ethDecision.data;
      const emoji = eth.decision === 'STRONG_BUY' || eth.decision === 'BUY' ? 'ğŸŸ¢' :
                    eth.decision === 'STRONG_SELL' || eth.decision === 'SELL' ? 'ğŸ”´' : 'ğŸŸ¡';
      const decisionTR = translateDecision(eth.decision);
      message += `${emoji} <b>Ethereum</b>: ${decisionTR} (%${(eth.confidence * 100).toFixed(0)} gÃ¼ven)\n`;
      message += `   ğŸ’µ Fiyat: $${eth.currentPrice.toFixed(0)}\n`;
    }

    message += `\n<i>ğŸ“… ${new Date().toLocaleString('tr-TR')}</i>`;

    await sendTelegramMessage(message);
    console.log('[Decision Engine Hourly] âœ… TamamlandÄ±');

  } catch (error) {
    console.error('[Decision Engine Hourly] âŒ Hata:', error.message);
  }
}

// GÃ¼nlÃ¼k KapanÄ±ÅŸ BTC-ETH DetaylÄ± Rapor
async function sendDailyDecisionEngine() {
  try {
    console.log('\n[Decision Engine Daily] ğŸ“… GÃ¼nlÃ¼k BTC-ETH DetaylÄ± Analizi...');

    const [btcDecision, ethDecision] = await Promise.all([
      httpGet(`${BASE_URL}/api/decision-engine?symbol=BTCUSDT`).catch(() => ({ data: null })),
      httpGet(`${BASE_URL}/api/decision-engine?symbol=ETHUSDT`).catch(() => ({ data: null }))
    ]);

    if (!btcDecision.data && !ethDecision.data) {
      console.log('[Decision Engine Daily] â„¹ï¸  Veri alÄ±namadÄ±');
      return;
    }

    // Karar tÃ¼rlerini TÃ¼rkÃ§eye Ã§evir
    const translateDecision = (decision) => {
      const translations = {
        'STRONG_BUY': 'GÃœÃ‡LÃœ AL',
        'BUY': 'AL',
        'HOLD': 'BEKLE',
        'SELL': 'SAT',
        'STRONG_SELL': 'GÃœÃ‡LÃœ SAT'
      };
      return translations[decision] || decision;
    };

    let message = '<b>ğŸ“… GÃœNLÃœK KAPANIÅ RAPORU</b>\n\n';

    if (btcDecision.data) {
      const btc = btcDecision.data;
      const emoji = btc.decision === 'STRONG_BUY' || btc.decision === 'BUY' ? 'ğŸŸ¢' :
                    btc.decision === 'STRONG_SELL' || btc.decision === 'SELL' ? 'ğŸ”´' : 'ğŸŸ¡';
      const decisionTR = translateDecision(btc.decision);

      message += `<b>â”â”â” ${emoji} Bitcoin (BTC) â”â”â”</b>\n`;
      message += `ğŸ’° GÃ¼ncel Fiyat: $${btc.currentPrice.toFixed(2)}\n`;
      message += `ğŸ¯ Tavsiye: <b>${decisionTR}</b> (%${(btc.confidence * 100).toFixed(1)} gÃ¼ven)\n\n`;
      message += `ğŸ“Š Ã–nerilen GiriÅŸ: $${btc.entryPrice.toFixed(2)}\n`;
      message += `ğŸ›‘ Zarar Durdur: $${btc.stopLoss.toFixed(2)}\n`;
      message += `ğŸ Hedef-1: $${btc.targets.tp1.toFixed(2)}\n`;
      message += `ğŸ Hedef-2: $${btc.targets.tp2.toFixed(2)}\n`;
      message += `ğŸ“ˆ Risk/Ã–dÃ¼l: ${btc.riskRewardRatio.toFixed(2)}:1\n`;
      message += `ğŸ“Š Sinyal Durumu: ${btc.buySignalsCount} AL / ${btc.sellSignalsCount} SAT\n\n`;
    }

    if (ethDecision.data) {
      const eth = ethDecision.data;
      const emoji = eth.decision === 'STRONG_BUY' || eth.decision === 'BUY' ? 'ğŸŸ¢' :
                    eth.decision === 'STRONG_SELL' || eth.decision === 'SELL' ? 'ğŸ”´' : 'ğŸŸ¡';
      const decisionTR = translateDecision(eth.decision);

      message += `<b>â”â”â” ${emoji} Ethereum (ETH) â”â”â”</b>\n`;
      message += `ğŸ’° GÃ¼ncel Fiyat: $${eth.currentPrice.toFixed(2)}\n`;
      message += `ğŸ¯ Tavsiye: <b>${decisionTR}</b> (%${(eth.confidence * 100).toFixed(1)} gÃ¼ven)\n\n`;
      message += `ğŸ“Š Ã–nerilen GiriÅŸ: $${eth.entryPrice.toFixed(2)}\n`;
      message += `ğŸ›‘ Zarar Durdur: $${eth.stopLoss.toFixed(2)}\n`;
      message += `ğŸ Hedef-1: $${eth.targets.tp1.toFixed(2)}\n`;
      message += `ğŸ Hedef-2: $${eth.targets.tp2.toFixed(2)}\n`;
      message += `ğŸ“ˆ Risk/Ã–dÃ¼l: ${eth.riskRewardRatio.toFixed(2)}:1\n`;
      message += `ğŸ“Š Sinyal Durumu: ${eth.buySignalsCount} AL / ${eth.sellSignalsCount} SAT\n\n`;
    }

    message += `<i>ğŸ“… ${new Date().toLocaleString('tr-TR')}</i>`;

    await sendTelegramMessage(message);
    console.log('[Decision Engine Daily] âœ… TamamlandÄ±');

  } catch (error) {
    console.error('[Decision Engine Daily] âŒ Hata:', error.message);
  }
}

// 4 Saatlik Top AL Coinleri - En Ä°yi FÄ±rsatlar
async function send4HourlyTopBuyCoins() {
  try {
    console.log('\n[4H Top Coins] ğŸ¯ Top AL coinleri taranÄ±yor...');

    // Top 50 coin listesini al
    const topCoins = await fetchTopUSDTPairs(50);
    if (!topCoins || topCoins.length === 0) {
      console.log('[4H Top Coins] âš ï¸  Coin listesi alÄ±namadÄ±');
      return;
    }

    // Karar tÃ¼rlerini TÃ¼rkÃ§eye Ã§evir
    const translateDecision = (decision) => {
      const translations = {
        'STRONG_BUY': 'GÃœÃ‡LÃœ AL',
        'BUY': 'AL',
        'HOLD': 'BEKLE',
        'SELL': 'SAT',
        'STRONG_SELL': 'GÃœÃ‡LÃœ SAT'
      };
      return translations[decision] || decision;
    };

    // Ä°lk 20 coin iÃ§in Decision Engine analizi yap (paralel)
    const analysisPromises = topCoins.slice(0, 20).map(coin =>
      httpGet(`${BASE_URL}/api/decision-engine?symbol=${coin.symbol}`)
        .then(res => ({ ...res.data, symbol: coin.symbol }))
        .catch(() => null)
    );

    const analyses = (await Promise.all(analysisPromises)).filter(a => a && a.decision);

    // Sadece BUY ve STRONG_BUY olanlarÄ± filtrele
    const buyCoins = analyses.filter(a =>
      a.decision === 'BUY' || a.decision === 'STRONG_BUY'
    );

    if (buyCoins.length === 0) {
      console.log('[4H Top Coins] â„¹ï¸  AL sinyali veren coin bulunamadÄ±');

      // KullanÄ±cÄ±ya bildirim gÃ¶nder
      const noSignalMessage = '<b>ğŸ¯ 4 SAATLÄ°K PÄ°YASA TARAMASI</b>\n\n' +
        'âš ï¸ Åu anda gÃ¼Ã§lÃ¼ AL sinyali veren kripto para bulunamadÄ±.\n\n' +
        'Piyasa beklemede veya risk seviyesi yÃ¼ksek.\n' +
        'Yeni fÄ±rsatlar iÃ§in takipte kalÄ±n!\n\n' +
        `<i>ğŸ“… ${new Date().toLocaleString('tr-TR')}</i>`;

      await sendTelegramMessage(noSignalMessage);
      return;
    }

    // Confidence'a gÃ¶re sÄ±rala ve top 8'i al
    buyCoins.sort((a, b) => b.confidence - a.confidence);
    const topBuyCoins = buyCoins.slice(0, 8);

    // Mesaj oluÅŸtur
    let message = '<b>ğŸ¯ EN Ä°YÄ° ALIÅ FIRSATLARI</b>\n';
    message += '<i>4 saatlik piyasa analizi sonuÃ§larÄ±</i>\n\n';
    message += `ğŸ“Š ${topBuyCoins.length} GÃ¼Ã§lÃ¼ FÄ±rsat Tespit Edildi\n\n`;

    topBuyCoins.forEach((coin, index) => {
      const emoji = coin.decision === 'STRONG_BUY' ? 'ğŸŸ¢ğŸŸ¢' : 'ğŸŸ¢';
      const symbol = coin.symbol.replace('USDT', '');
      const decisionTR = translateDecision(coin.decision);

      message += `${index + 1}. ${emoji} <b>${symbol}</b>\n`;
      message += `   ğŸ’µ Fiyat: $${coin.currentPrice.toFixed(coin.currentPrice >= 1 ? 2 : 6)}\n`;
      message += `   ğŸ¯ Tavsiye: ${decisionTR} (%${(coin.confidence * 100).toFixed(0)} gÃ¼ven)\n`;
      message += `   ğŸ“ˆ Risk/Ã–dÃ¼l: ${coin.riskRewardRatio.toFixed(1)}:1`;
      message += ` | Hedef: $${coin.targets.tp1.toFixed(coin.targets.tp1 >= 1 ? 2 : 6)}\n`;

      if (index < topBuyCoins.length - 1) message += '\n';
    });

    message += `\n<i>ğŸ“… ${new Date().toLocaleString('tr-TR')}</i>`;

    console.log(`[4H Top Coins] âœ… ${topBuyCoins.length} AL coini bulundu, gÃ¶nderiliyor...`);
    await sendTelegramMessage(message);
    console.log('[4H Top Coins] âœ… TamamlandÄ±!');

  } catch (error) {
    console.error('[4H Top Coins] âŒ Hata:', error.message);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CRON SCHEDULER BAÅLANGICI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// âš¡ 15 DAKÄ°KALIK (Her 15 dakikada - En gÃ¼venilir AL sinyalleri)
cron.schedule('*/15 * * * *', async () => {
  const now = new Date().toLocaleString('tr-TR');
  console.log(`\nâ° [${now}] 15 DakikalÄ±k AL Sinyali Scheduler Tetiklendi`);
  await sendTopBuySignals();
});

// ğŸŒ 30 DAKÄ°KALIK (Her 30 dakikada - Kritik Piyasa OlaylarÄ±)
cron.schedule('*/30 * * * *', async () => {
  const now = new Date().toLocaleString('tr-TR');
  console.log(`\nâ° [${now}] 30 DakikalÄ±k Global Market Events Tetiklendi`);
  await sendCriticalMarketEvents();
});

// 1ï¸âƒ£ SAATLÄ°K (her saat baÅŸÄ± - BTC-ETH Analizi)
cron.schedule('0 * * * *', async () => {
  const now = new Date().toLocaleString('tr-TR');
  console.log(`\nâ° [${now}] 1 Saatlik BTC-ETH Analizi Tetiklendi`);
  await sendHourlyBTCETHAnalysis();
  await sendMarketCorrelation();
});

// ğŸ“Š TA-LIB SAATLÄ°K (Her saat +5 dakika)
cron.schedule('5 * * * *', async () => {
  const now = new Date().toLocaleString('tr-TR');
  console.log(`\nâ° [${now}] TA-Lib Saatlik Sinyaller Tetiklendi`);
  await sendTALibHourlySignals();
});

// ğŸ›¡ï¸ MUHAFAZAKAR ALIM SÄ°NYALLERÄ° (Her saat +30 dakika)
cron.schedule('30 * * * *', async () => {
  const now = new Date().toLocaleString('tr-TR');
  console.log(`\nâ° [${now}] Muhafazakar AlÄ±m Sinyalleri Tetiklendi`);
  await sendConservativeSignals();
});

// â° SAATLÄ°K BTC-ETH KARAR ANALÄ°ZÄ° (Her saat +45 dakika)
cron.schedule('45 * * * *', async () => {
  const now = new Date().toLocaleString('tr-TR');
  console.log(`\nâ° [${now}] ğŸ¯ Saatlik BTC-ETH Karar Analizi Tetiklendi`);
  await sendHourlyDecisionEngine();
});

// ğŸ¯ 4 SAATLÄ°K TOP AL COÄ°NLERÄ° (00:15, 04:15, 08:15, 12:15, 16:15, 20:15)
cron.schedule('15 */4 * * *', async () => {
  const now = new Date().toLocaleString('tr-TR');
  console.log(`\nâ° [${now}] ğŸ¯ 4 Saatlik Top AL Coinleri Tetiklendi`);
  await send4HourlyTopBuyCoins();
});

// 2ï¸âƒ£ 4 SAATLÄ°K (00:00, 04:00, 08:00, 12:00, 16:00, 20:00 UTC)
cron.schedule('0 */4 * * *', async () => {
  const now = new Date().toLocaleString('tr-TR');
  console.log(`\nâ° [${now}] 4 Saatlik DetaylÄ± Market Raporu Tetiklendi`);
  await send4HourlyMarketReport();
  await sendCryptoNews();
  await sendOmnipotentFutures();
  await sendBreakoutSignals();
});

// ğŸ“Š TA-LIB 4 SAATLÄ°K (Her 4 saat +10 dakika)
cron.schedule('10 */4 * * *', async () => {
  const now = new Date().toLocaleString('tr-TR');
  console.log(`\nâ° [${now}] TA-Lib 4 Saatlik DetaylÄ± Analiz Tetiklendi`);
  await sendTALib4HourlySignals();
});

// ğŸ“… GÃœNLÃœK KAPANIÅ - BTC-ETH KARAR RAPORU (00:00 UTC - GÃ¼nlÃ¼k kapanÄ±ÅŸ)
cron.schedule('0 0 * * *', async () => {
  const now = new Date().toLocaleString('tr-TR');
  console.log(`\nâ° [${now}] ğŸ“… GÃ¼nlÃ¼k KapanÄ±ÅŸ BTC-ETH Karar Raporu Tetiklendi`);
  await sendDailyDecisionEngine();
});

// ğŸŒ DÃœNYA BORSALARI PRE-MARKET ANALÄ°ZLERÄ°

// ğŸ‡¯ğŸ‡µ Tokyo Pre-Market (23:45 UTC)
cron.schedule('45 23 * * *', async () => {
  const now = new Date().toLocaleString('tr-TR');
  console.log(`\nâ° [${now}] ğŸ‡¯ğŸ‡µ Tokyo Pre-Market Analizi Tetiklendi`);
  await sendTokyoPreMarket();
});

// ğŸ‡¨ğŸ‡³ Hong Kong/Shanghai Pre-Market (01:15 UTC)
cron.schedule('15 1 * * *', async () => {
  const now = new Date().toLocaleString('tr-TR');
  console.log(`\nâ° [${now}] ğŸ‡¨ğŸ‡³ Hong Kong/Shanghai Pre-Market Analizi Tetiklendi`);
  await sendChinaPreMarket();
});

// ğŸ‡¬ğŸ‡§ London Pre-Market (07:45 UTC)
cron.schedule('45 7 * * *', async () => {
  const now = new Date().toLocaleString('tr-TR');
  console.log(`\nâ° [${now}] ğŸ‡¬ğŸ‡§ London Pre-Market Analizi Tetiklendi`);
  await sendLondonPreMarket();
});

// ğŸ‡ºğŸ‡¸ NYSE Pre-Market PREMIUM (14:15 UTC) - EN Ã–NEMLÄ° SEANS
cron.schedule('15 14 * * *', async () => {
  const now = new Date().toLocaleString('tr-TR');
  console.log(`\nâ° [${now}] ğŸ‡ºğŸ‡¸ NYSE Pre-Market PREMIUM Analizi Tetiklendi â­`);
  await sendNYSEPreMarket();
});

// ğŸ‡ºğŸ‡¸ NYSE Close (20:45 UTC)
cron.schedule('45 20 * * *', async () => {
  const now = new Date().toLocaleString('tr-TR');
  console.log(`\nâ° [${now}] ğŸ‡ºğŸ‡¸ NYSE Close Analizi Tetiklendi`);
  await sendNYSECloseAnalysis();
});

// 3ï¸âƒ£ GÃœNLÃœK (UTC 00:00 = TÃ¼rkiye 03:00)
cron.schedule('0 0 * * *', async () => {
  const now = new Date().toLocaleString('tr-TR');
  console.log(`\nâ° [${now}] GÃ¼nlÃ¼k Scheduler Tetiklendi`);
  await sendNirvanaDaily();
  await sendBTCETHAnalysis();
});

// ğŸ“Š TA-LIB GÃœNLÃœK (UTC 00:10)
cron.schedule('10 0 * * *', async () => {
  const now = new Date().toLocaleString('tr-TR');
  console.log(`\nâ° [${now}] TA-Lib GÃ¼nlÃ¼k KapsamlÄ± Analiz Tetiklendi`);
  await sendTALibDailySignals();
});

// 4ï¸âƒ£ HAFTALIK (Pazartesi UTC 00:00)
cron.schedule('0 0 * * 1', async () => {
  const now = new Date().toLocaleString('tr-TR');
  console.log(`\nâ° [${now}] HaftalÄ±k Scheduler Tetiklendi`);
  await sendNirvanaDaily();
});

console.log('âœ… TÃ¼m Cron Job\'lar aktif edildi!');
console.log('\nğŸ“… SCHEDULER TAKVÄ°MÄ° (Toplam 16+ ZamanlanmÄ±ÅŸ GÃ¶rev):');
console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
console.log('  âš¡ 15 DakikalÄ±k: EN GÃœVENÄ°LÄ°R AL SÄ°NYALLERÄ°');
console.log('  ğŸŒ 30 DakikalÄ±k: GLOBAL CRITICAL MARKET EVENTS');
console.log('  ğŸ• Saatlik (00:00): BTC-ETH HÄ±zlÄ± Analiz');
console.log('  ğŸ“Š Saatlik (00:05): TA-Lib Teknik Sinyaller â­NEW');
console.log('  ğŸ•“ 4 Saatlik (00:00, 04:00, 08:00, 12:00, 16:00, 20:00): Market Raporu');
console.log('  ğŸ“Š 4 Saatlik (00:10, 04:10 ...): TA-Lib DetaylÄ± Analiz â­NEW');
console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
console.log('ğŸŒ DÃœNYA BORSALARI PRE-MARKET ANALÄ°ZLERÄ°:');
console.log('  ğŸ‡¯ğŸ‡µ 23:45 UTC: Tokyo Pre-Market â­NEW');
console.log('  ğŸ‡¨ğŸ‡³ 01:15 UTC: Hong Kong/Shanghai Pre-Market â­NEW');
console.log('  ğŸ‡¬ğŸ‡§ 07:45 UTC: London Pre-Market â­NEW');
console.log('  ğŸ‡ºğŸ‡¸ 14:15 UTC: NYSE Pre-Market PREMIUM (Altcoin AL/SAT) â­NEW');
console.log('  ğŸ‡ºğŸ‡¸ 20:45 UTC: NYSE Close Analysis â­NEW');
console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
console.log('  ğŸ“… 00:00 UTC: GÃ¼nlÃ¼k (Nirvana + BTC-ETH)');
console.log('  ğŸ“Š 00:10 UTC: TA-Lib GÃ¼nlÃ¼k KapsamlÄ± Analiz â­NEW');
console.log('  ğŸ“† Pazartesi 00:00 UTC: HaftalÄ±k Nirvana Ã–zet');
console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
console.log('\nğŸ¯ YENÄ° SÄ°STEM Ã–ZELLÄ°KLERÄ°:');
console.log('   âœ… TA-Lib 158 Ä°ndikatÃ¶r (RSI, MACD, BB, EMA, ADX)');
console.log('   âœ… 5 DÃ¼nya BorsasÄ± Takibi (Tokyo, HK, London, NYSE)');
console.log('   âœ… Altcoin MarketCap AL/SAT AlgoritmasÄ±');
console.log('   âœ… White-Hat Etik Kurallar');
console.log('   âœ… 7/24 Kesintisiz Ã‡alÄ±ÅŸma');
console.log('\nâ³ Scheduler Ã§alÄ±ÅŸÄ±yor... (Ctrl+C ile durdur)\n');

// Graceful shutdown
process.on('SIGINT', () => {
  console.log('\n\nğŸ›‘ Scheduler durduruluyor...');
  process.exit(0);
});

process.on('SIGTERM', () => {
  console.log('\n\nğŸ›‘ Scheduler PM2 tarafÄ±ndan durduruldu.');
  process.exit(0);
});

// ============================================================================
// ğŸ’ PREMIUM FEATURES - PHASE 1
// ============================================================================
const premiumFeatures = require('./premium-features.js');

// ğŸš¨ LIQUIDATION CASCADE RISK (Her 2 saatte - yÃ¼ksek volatilite kontrol)
cron.schedule('30 */2 * * *', async () => {
  const now = new Date().toLocaleString('tr-TR');
  console.log(`\nâ° [${now}] ğŸš¨ Liquidation Cascade Risk Check Tetiklendi`);
  await premiumFeatures.sendLiquidationRiskAlert();
});

// ğŸ’° FUNDING RATE ARBITRAGE (Her 8 saatte - funding zamanlarÄ±nda)
cron.schedule('0 */8 * * *', async () => {
  const now = new Date().toLocaleString('tr-TR');
  console.log(`\nâ° [${now}] ğŸ’° Funding Rate Arbitrage Check Tetiklendi`);
  await premiumFeatures.sendFundingArbitrageAlert();
});

// ğŸ’” BTC-ETH CORRELATION BREAKDOWN (Her 6 saatte)
cron.schedule('15 */6 * * *', async () => {
  const now = new Date().toLocaleString('tr-TR');
  console.log(`\nâ° [${now}] ğŸ’” BTC-ETH Correlation Check Tetiklendi`);
  await premiumFeatures.sendCorrelationBreakdownAlert();
});

// ğŸ”„ MOMENTUM SHIFT DETECTOR (Her 4 saatte - 4h chart analizi)
cron.schedule('0 */4 * * *', async () => {
  const now = new Date().toLocaleString('tr-TR');
  console.log(`\nâ° [${now}] ğŸ”„ Momentum Shift Detection Tetiklendi`);
  await premiumFeatures.sendMomentumShiftAlert();
});

// ğŸ“Š VOLATILITY FORECAST ENGINE (Her 12 saatte - piyasa volatilite analizi)
cron.schedule('0 */12 * * *', async () => {
  const now = new Date().toLocaleString('tr-TR');
  console.log(`\nâ° [${now}] ğŸ“Š Volatility Forecast Engine Tetiklendi`);
  await premiumFeatures.sendVolatilityForecastAlert();
});

// âš¡ FLASH CRASH EARLY WARNING (Her 1 saatte - kritik risk taramasÄ±)
cron.schedule('0 * * * *', async () => {
  const now = new Date().toLocaleString('tr-TR');
  console.log(`\nâ° [${now}] âš¡ Flash Crash Early Warning Tetiklendi`);
  await premiumFeatures.sendFlashCrashAlert();
});

// ğŸ‹ ON-CHAIN WHALE MONITOR (Her 10 dakikada - whale aktivitesi Ã§ok dinamik)
cron.schedule('*/10 * * * *', async () => {
  const now = new Date().toLocaleString('tr-TR');
  console.log(`\nâ° [${now}] ğŸ‹ On-Chain Whale Monitor Tetiklendi`);
  await premiumFeatures.sendWhaleActivityAlert();
});

// ğŸ“Š ORDER BOOK DEPTH ANALYZER (Her 1 saatte - bÃ¼yÃ¼k duvar analizi)
cron.schedule('5 * * * *', async () => {
  const now = new Date().toLocaleString('tr-TR');
  console.log(`\nâ° [${now}] ğŸ“Š Order Book Depth Analyzer Tetiklendi`);
  await premiumFeatures.sendOrderBookAlert();
});

console.log('\nğŸ’ PREMIUM FEATURES - 8 Ã–ZELLIK AKTIF!');
console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
console.log('  ğŸš¨ Her 2 saat: Liquidation Cascade Risk Analysis');
console.log('  ğŸ’° Her 8 saat: Funding Rate Arbitrage Scanner');
console.log('  ğŸ’” Her 6 saat: BTC-ETH Correlation Breakdown');
console.log('  ğŸ”„ Her 4 saat: Momentum Shift Detector');
console.log('  ğŸ“Š Her 12 saat: Volatility Forecast Engine');
console.log('  âš¡ Her 1 saat: Flash Crash Early Warning');
console.log('  ğŸ‹ Her 10 dakika: On-Chain Whale Monitor (NEW!)');
console.log('  ğŸ“Š Her 1 saat: Order Book Depth Analyzer (NEW!)');
console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');
