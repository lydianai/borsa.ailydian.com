#!/usr/bin/env node
/**
 * ğŸ¤– TELEGRAM SCHEDULER RUNNER (Plain JavaScript)
 * PM2 ile kolay Ã§alÄ±ÅŸma iÃ§in JavaScript wrapper
 */

// Load environment variables from .env.local (2 directories up)
const path = require('path');
require('dotenv').config({
  path: path.join(__dirname, '../../.env.local')
});

const cron = require('node-cron');
const http = require('http');
const https = require('https');

const BASE_URL = process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000';
const BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN;
const CHAT_IDS = process.env.TELEGRAM_ALLOWED_CHAT_IDS ?
  process.env.TELEGRAM_ALLOWED_CHAT_IDS.split(',').map(id => id.trim()) : [];

console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
console.log('ğŸ¤– TELEGRAM SCHEDULER BAÅLATILIYOR...');
console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
console.log(`ğŸ“Š Base URL: ${BASE_URL}`);
console.log(`ğŸ‘¤ Chat IDs: ${CHAT_IDS.length} adet`);
console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');

// Simple HTTP GET
function httpGet(url) {
  return new Promise((resolve, reject) => {
    const protocol = url.startsWith('https') ? https : http;
    protocol.get(url, (res) => {
      let data = '';
      res.on('data', (chunk) => data += chunk);
      res.on('end', () => {
        try {
          resolve(JSON.parse(data));
        } catch (e) {
          resolve({ error: 'Parse error' });
        }
      });
    }).on('error', reject);
  });
}

// Sleep helper
function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

// Telegram mesaj gÃ¶nder (with retry and timeout)
async function sendTelegramMessage(message, maxRetries = 3) {
  console.log('[DEBUG sendTelegramMessage] Message received:', typeof message, message ? message.length : 'UNDEFINED');
  console.log('[DEBUG sendTelegramMessage] Message preview:', message ? message.substring(0, 50) : 'NO MESSAGE');

  if (!BOT_TOKEN || CHAT_IDS.length === 0) {
    console.log('[Telegram] âš ï¸  Bot token veya chat ID bulunamadÄ±');
    return;
  }

  for (const chatId of CHAT_IDS) {
    let retries = 0;
    let success = false;

    while (retries < maxRetries && !success) {
      try {
        const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;
        const data = JSON.stringify({
          chat_id: chatId,
          text: message,
          parse_mode: 'HTML'
        });

        console.log('[DEBUG sendTelegramMessage] JSON data:', data.substring(0, 150));

        await new Promise((resolve, reject) => {
          const timeout = setTimeout(() => {
            req.destroy();
            reject(new Error('Request timeout'));
          }, 10000); // 10 second timeout

          const req = https.request(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Content-Length': Buffer.byteLength(data, 'utf8')
            }
          }, (res) => {
            clearTimeout(timeout);
            let responseData = '';
            res.on('data', (chunk) => responseData += chunk);
            res.on('end', () => {
              if (res.statusCode === 200) {
                resolve(responseData);
              } else {
                reject(new Error(`HTTP ${res.statusCode}: ${responseData}`));
              }
            });
          });

          req.on('error', (err) => {
            clearTimeout(timeout);
            reject(err);
          });

          req.write(data);
          req.end();
        });

        console.log(`[Telegram] âœ… Mesaj gÃ¶nderildi: ${chatId}`);
        success = true;

        // Delay between messages to prevent rate limiting
        await sleep(500);

      } catch (error) {
        retries++;
        console.error(`[Telegram] âŒ Deneme ${retries}/${maxRetries} baÅŸarÄ±sÄ±z: ${error.message}`);

        if (retries < maxRetries) {
          // Exponential backoff: 1s, 2s, 4s
          const delay = Math.pow(2, retries) * 1000;
          console.log(`[Telegram] â³ ${delay}ms bekleniyor...`);
          await sleep(delay);
        } else {
          console.error(`[Telegram] âŒ TÃ¼m denemeler baÅŸarÄ±sÄ±z oldu: ${chatId}`);
        }
      }
    }
  }
}

// ============================================================================
// SCHEDULER FUNCTIONS
// ============================================================================

async function sendNirvanaDaily() {
  try {
    console.log('\n[Scheduler] ğŸ“Š Nirvana gÃ¼nlÃ¼k Ã¶zet gÃ¶nderiliyor...');
    const data = await httpGet(`${BASE_URL}/api/nirvana`);

    if (!data.success) {
      console.log('[Scheduler] âŒ Nirvana API hatasÄ±');
      return;
    }

    const message = `
â•­â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•®
â”ƒ ğŸŒŸ NÄ°RVANA Ã–ZET ğŸŒŸ
â”œâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”¤
â”ƒ ğŸ“Š Aktif Strateji: ${data.data.activeStrategies}/${data.data.totalStrategies}
â”ƒ ğŸ¯ Toplam Sinyal: ${data.data.totalSignals}
â”ƒ ${data.data.marketSentiment === 'BULLISH' ? 'ğŸŸ¢ YÃœKSELÄ°Å' : data.data.marketSentiment === 'BEARISH' ? 'ğŸ”´ DÃœÅÃœÅ' : 'ğŸŸ¡ NÃ–TR'} (${data.data.sentimentScore})
â”œâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”¤
â”ƒ âŒš ${new Date().toLocaleString('tr-TR', { hour: '2-digit', minute: '2-digit' })}
â•°â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•¯
`.trim();

    await sendTelegramMessage(message);
    console.log('[Scheduler] âœ… Nirvana Ã¶zet gÃ¶nderildi');
  } catch (error) {
    console.error('[Scheduler] âŒ Nirvana hatasÄ±:', error.message);
  }
}

async function sendCryptoNews() {
  try {
    console.log('\n[Scheduler] ğŸ“° Crypto News kontrol ediliyor...');
    const data = await httpGet(`${BASE_URL}/api/crypto-news?refresh=true`);

    if (!data.success || !data.data || data.data.length === 0) {
      console.log('[Scheduler] â„¹ï¸  Yeni haber bulunamadÄ±');
      return;
    }

    const importantNews = data.data.filter(n => n.impactScore >= 8);

    for (const news of importantNews.slice(0, 3)) {
      const message = `
â•­â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•®
â”ƒ ğŸ“° KRÄ°PTO HABER
â”œâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”¤
â”ƒ <b>${news.titleTR || news.title}</b>
â”œâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”¤
â”ƒ ${(news.descriptionTR || news.description || '').substring(0, 150)}...
â”œâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”¤
â”ƒ ğŸ¯ Etki: ${news.impactScore}/10
â”ƒ âŒš ${new Date().toLocaleString('tr-TR', { hour: '2-digit', minute: '2-digit' })}
â•°â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•¯
`.trim();

      await sendTelegramMessage(message);
      await new Promise(resolve => setTimeout(resolve, 1000)); // 1s bekle
    }

    console.log('[Scheduler] âœ… Crypto News gÃ¶nderildi');
  } catch (error) {
    console.error('[Scheduler] âŒ Crypto News hatasÄ±:', error.message);
  }
}

async function sendMarketCorrelation() {
  try {
    console.log('\n[Scheduler] ğŸ“Š Market Correlation sinyalleri gÃ¶nderiliyor...');
    const data = await httpGet(`${BASE_URL}/api/market-correlation?limit=5`);

    if (!data.success || !data.data || !data.data.correlations || data.data.correlations.length === 0) {
      console.log('[Scheduler] â„¹ï¸  Market Correlation verisi yok');
      return;
    }

    const topCoins = data.data.correlations.slice(0, 5);
    let coinList = '';
    topCoins.forEach((coin, index) => {
      const medal = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', '4ï¸âƒ£', '5ï¸âƒ£'][index];
      const correlation = (coin.btcCorrelation * 100).toFixed(0);
      coinList += `â”ƒ ${medal} ${coin.symbol}: ${correlation}% (${coin.omnipotentScore.toFixed(0)})\n`;
    });

    const message = `
â•­â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•®
â”ƒ ğŸ“Š MARKET CORRELATION
â”œâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”¤
${coinList}â”œâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”¤
â”ƒ âŒš ${new Date().toLocaleString('tr-TR', { hour: '2-digit', minute: '2-digit' })}
â•°â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•¯
`.trim();

    await sendTelegramMessage(message);
    console.log('[Scheduler] âœ… Market Correlation gÃ¶nderildi');
  } catch (error) {
    console.error('[Scheduler] âŒ Market Correlation hatasÄ±:', error.message);
  }
}

async function sendOmnipotentFutures() {
  try {
    console.log('\n[Scheduler] ğŸ¯ Omnipotent Futures sinyalleri gÃ¶nderiliyor...');
    const data = await httpGet(`${BASE_URL}/api/omnipotent-futures?limit=10`);

    if (!data.success || !data.data || !data.data.futures || data.data.futures.length === 0) {
      console.log('[Scheduler] â„¹ï¸  Omnipotent Futures verisi yok');
      return;
    }

    const strongSignals = data.data.futures.filter(s => s.wyckoffScore >= 70);

    if (strongSignals.length === 0) {
      console.log('[Scheduler] â„¹ï¸  GÃ¼Ã§lÃ¼ Wyckoff sinyali yok');
      return;
    }

    const topSignal = strongSignals[0];
    const phaseEmoji = {
      'ACCUMULATION': 'ğŸŸ¢',
      'MARKUP': 'ğŸš€',
      'DISTRIBUTION': 'ğŸ”´',
      'MARKDOWN': 'â¬‡ï¸'
    };

    const message = `
â•­â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•®
â”ƒ ğŸ¯ OMNIPOTENT FUTURES
â”œâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”¤
â”ƒ ğŸ’° ${topSignal.symbol}
â”ƒ ${phaseEmoji[topSignal.wyckoffPhase] || 'âšª'} ${topSignal.wyckoffPhase}
â”ƒ ğŸ“ˆ Skor: ${topSignal.wyckoffScore.toFixed(0)}/100
â”ƒ ğŸ’ Confidence: ${(topSignal.confidence * 100).toFixed(0)}%
â”œâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”¤
â”ƒ ğŸ”¥ ${strongSignals.length} gÃ¼Ã§lÃ¼ sinyal aktif
â”ƒ âŒš ${new Date().toLocaleString('tr-TR', { hour: '2-digit', minute: '2-digit' })}
â•°â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•¯
`.trim();

    await sendTelegramMessage(message);
    console.log('[Scheduler] âœ… Omnipotent Futures gÃ¶nderildi');
  } catch (error) {
    console.error('[Scheduler] âŒ Omnipotent Futures hatasÄ±:', error.message);
  }
}

async function sendBreakoutSignals() {
  try {
    console.log('\n[Scheduler] ğŸ’¥ Breakout Signals kontrol ediliyor...');
    const data = await httpGet(`${BASE_URL}/api/breakout-signals?limit=10`);

    if (!data.success || !data.data || data.data.length === 0) {
      console.log('[Scheduler] â„¹ï¸  Breakout signal verisi yok');
      return;
    }

    const highConfidenceSignals = data.data.filter(s => s.confidence >= 0.75);

    if (highConfidenceSignals.length === 0) {
      console.log('[Scheduler] â„¹ï¸  YÃ¼ksek confidence breakout yok');
      return;
    }

    const buySignals = highConfidenceSignals.filter(s => s.signal === 'BUY').length;
    const sellSignals = highConfidenceSignals.filter(s => s.signal === 'SELL').length;

    const message = `
â•­â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•®
â”ƒ ğŸ’¥ BREAKOUT SIGNALS
â”œâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”¤
â”ƒ ğŸŸ¢ AlÄ±ÅŸ: ${buySignals} sinyal
â”ƒ ğŸ”´ SatÄ±ÅŸ: ${sellSignals} sinyal
â”ƒ ğŸ’ Toplam: ${highConfidenceSignals.length} yÃ¼ksek gÃ¼ven
â”œâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”¤
â”ƒ âŒš ${new Date().toLocaleString('tr-TR', { hour: '2-digit', minute: '2-digit' })}
â•°â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•¯
`.trim();

    await sendTelegramMessage(message);
    console.log('[Scheduler] âœ… Breakout Signals gÃ¶nderildi');
  } catch (error) {
    console.error('[Scheduler] âŒ Breakout Signals hatasÄ±:', error.message);
  }
}

async function sendBTCETHAnalysis() {
  try {
    console.log('\n[Scheduler] ğŸ”— BTC-ETH Analysis gÃ¶nderiliyor...');
    const data = await httpGet(`${BASE_URL}/api/btc-eth-analysis`);

    if (!data.success || !data.data) {
      console.log('[Scheduler] âŒ BTC-ETH Analysis hatasÄ±');
      return;
    }

    const { correlation30d, correlation7d, trend, volumeRatio } = data.data;
    const trendEmoji = trend === 'Rising' ? 'ğŸ“ˆ' : trend === 'Falling' ? 'ğŸ“‰' : 'â¡ï¸';

    const message = `
â•­â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•®
â”ƒ ğŸ”— BTC-ETH ANALYSIS
â”œâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”¤
â”ƒ ğŸ“Š 30 GÃ¼n: ${(correlation30d * 100).toFixed(0)}%
â”ƒ ğŸ“… 7 GÃ¼n: ${(correlation7d * 100).toFixed(0)}%
â”ƒ ${trendEmoji} Trend: ${trend}
â”ƒ ğŸ“Š Volume: ${volumeRatio.toFixed(2)}x
â”œâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”¤
â”ƒ âŒš ${new Date().toLocaleString('tr-TR', { hour: '2-digit', minute: '2-digit' })}
â•°â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•¯
`.trim();

    await sendTelegramMessage(message);
    console.log('[Scheduler] âœ… BTC-ETH Analysis gÃ¶nderildi');
  } catch (error) {
    console.error('[Scheduler] âŒ BTC-ETH Analysis hatasÄ±:', error.message);
  }
}

// ============================================================================
// CRON JOBS
// ============================================================================

// Test mesajÄ± (baÅŸlangÄ±Ã§ta)
setTimeout(async () => {
  const testMessage = `ğŸ¤– TELEGRAM SCHEDULER AKTÄ°F!

âœ… Scheduler servisi baÅŸarÄ±yla baÅŸlatÄ±ldÄ±
â° ${new Date().toLocaleString('tr-TR')}

ğŸ“… Zamanlamalar:
- ğŸ• Saatlik: Market sinyalleri
- ğŸ•“ 4 Saatlik: Futures + Haberler
- ğŸ“… GÃ¼nlÃ¼k: Nirvana + BTC-ETH
- ğŸ“† HaftalÄ±k: Nirvana Ã¶zet

Sistem 7/24 Ã§alÄ±ÅŸÄ±yor! ğŸš€`;

  console.log('[DEBUG] Test message length:', testMessage.length);
  console.log('[DEBUG] Test message preview:', testMessage.substring(0, 100));
  console.log('[DEBUG] BOT_TOKEN length:', (BOT_TOKEN || '').length);
  console.log('[DEBUG] CHAT_IDS:', CHAT_IDS);

  await sendTelegramMessage(testMessage);
}, 3000);

// âš¡ TOP BUY SÄ°NYALLERÄ° (Her 15 dakikada) - ENHANCED VERSION
async function sendTopBuySignals() {
  try {
    console.log('\n[Scheduler] ğŸ¯ TÃœMÃœ STRATEJÄ°LER taranÄ±yor (6 strateji)...');

    // TÃœM sinyal kaynaklarÄ±nÄ± paralel olarak Ã§ek (6 strateji)
    const [aiSignals, quantumSignals, conservativeSignals, breakoutSignals, omnipotentSignals, nirvanaData] = await Promise.all([
      httpGet(`${BASE_URL}/api/ai-signals?limit=20`).catch(() => ({ data: { signals: [] } })),
      httpGet(`${BASE_URL}/api/quantum-signals?limit=20`).catch(() => ({ data: { signals: [] } })),
      httpGet(`${BASE_URL}/api/conservative-signals?limit=20`).catch(() => ({ data: { signals: [] } })),
      httpGet(`${BASE_URL}/api/breakout-retest?limit=20`).catch(() => ({ data: { signals: [] } })),
      httpGet(`${BASE_URL}/api/omnipotent-futures?limit=20`).catch(() => ({ data: { futures: [] } })),
      httpGet(`${BASE_URL}/api/nirvana`).catch(() => ({ data: { strategies: [] } })),
    ]);

    // TÃ¼m BUY sinyallerini topla
    const allSignals = [];

    // AI Signals
    if (aiSignals.data?.signals) {
      aiSignals.data.signals.forEach(s => {
        if (s.type === 'BUY' && s.confidence >= 70) {
          allSignals.push({
            symbol: s.symbol,
            confidence: s.confidence,
            strategy: 'AI',
            price: s.price,
            targetPrice: s.price ? s.price * 1.05 : null, // 5% target
            stopLoss: s.price ? s.price * 0.98 : null, // 2% stop loss
            riskReward: '1:2.5',
            reason: s.reasoning?.substring(0, 60) || 'AI Analysis'
          });
        }
      });
    }

    // Quantum Signals
    if (quantumSignals.data?.signals) {
      quantumSignals.data.signals.forEach(s => {
        if (s.type === 'BUY' && s.confidence >= 70) {
          allSignals.push({
            symbol: s.symbol,
            confidence: s.confidence,
            strategy: 'Quantum',
            price: s.price,
            targetPrice: s.price ? s.price * 1.06 : null, // 6% target
            stopLoss: s.price ? s.price * 0.97 : null, // 3% stop loss
            riskReward: '1:2',
            quantumScore: s.quantumScore,
            reason: 'Quantum Portfolio Optimization'
          });
        }
      });
    }

    // Conservative Signals
    if (conservativeSignals.data?.signals) {
      conservativeSignals.data.signals.forEach(s => {
        if (s.type === 'BUY' && s.confidence >= 70) {
          allSignals.push({
            symbol: s.symbol,
            confidence: s.confidence,
            strategy: 'Conservative',
            price: s.price,
            targetPrice: s.price ? s.price * 1.04 : null, // 4% target (conservative)
            stopLoss: s.price ? s.price * 0.99 : null, // 1% stop loss (tight)
            riskReward: '1:4',
            reason: 'Low Risk High Volume'
          });
        }
      });
    }

    // Breakout Signals
    if (breakoutSignals.data?.signals) {
      breakoutSignals.data.signals.forEach(s => {
        if (s.type === 'BUY' && s.confidence >= 70) {
          allSignals.push({
            symbol: s.symbol,
            confidence: s.confidence,
            strategy: 'Breakout',
            price: s.price,
            targetPrice: s.price ? s.price * 1.08 : null, // 8% target (aggressive)
            stopLoss: s.price ? s.price * 0.96 : null, // 4% stop loss
            riskReward: '1:2',
            reason: 'Support/Resistance Break'
          });
        }
      });
    }

    // Omnipotent Futures (Wyckoff ACCUMULATION ve MARKUP fazlarÄ±)
    if (omnipotentSignals.data?.futures) {
      omnipotentSignals.data.futures.forEach(s => {
        if ((s.wyckoffPhase === 'ACCUMULATION' || s.wyckoffPhase === 'MARKUP') && s.confidence >= 75) {
          allSignals.push({
            symbol: s.symbol,
            confidence: s.confidence,
            strategy: 'Omnipotent',
            price: s.price,
            targetPrice: s.price ? s.price * 1.10 : null, // 10% target (high potential)
            stopLoss: s.price ? s.price * 0.95 : null, // 5% stop loss
            riskReward: '1:2',
            wyckoffPhase: s.wyckoffPhase,
            reason: `Wyckoff ${s.wyckoffPhase}`
          });
        }
      });
    }

    // Nirvana Best Strategies (En yÃ¼ksek BUY sinyallerine sahip stratejiler)
    if (nirvanaData.data?.strategies) {
      const bestStrategies = nirvanaData.data.strategies
        .filter(st => st.status === 'active' && st.buySignals > 0 && st.avgConfidence >= 70)
        .sort((a, b) => (b.buySignals * b.avgConfidence) - (a.buySignals * a.avgConfidence))
        .slice(0, 3); // En iyi 3 strateji

      bestStrategies.forEach(st => {
        // Her stratejinin bir temsili sinyali olarak ekle
        allSignals.push({
          symbol: 'MULTI', // Ã‡oklu coin stratejisi
          confidence: Math.round(st.avgConfidence),
          strategy: 'Nirvana',
          strategyName: st.name.substring(0, 25),
          buySignalsCount: st.buySignals,
          price: null, // Multi-coin, tek fiyat yok
          reason: `${st.buySignals} BUY signals`
        });
      });
    }

    if (allSignals.length === 0) {
      console.log('[Scheduler] â„¹ï¸  Yeterli gÃ¼venilirlikte AL sinyali yok (min %70)');
      return;
    }

    // Confidence'a gÃ¶re sÄ±rala
    allSignals.sort((a, b) => b.confidence - a.confidence);

    // Birbirinden farklÄ± coinleri seÃ§ (diversity iÃ§in) - Nirvana hariÃ§
    const uniqueSignals = [];
    const seenSymbols = new Set();

    for (const signal of allSignals) {
      if (signal.symbol === 'MULTI') {
        // Nirvana stratejilerini her zaman ekle (multi-coin)
        uniqueSignals.push(signal);
      } else if (!seenSymbols.has(signal.symbol) && uniqueSignals.length < 10) {
        uniqueSignals.push(signal);
        seenSymbols.add(signal.symbol);
      }
      if (uniqueSignals.length >= 10) break; // Maksimum 10 sinyal
    }

    if (uniqueSignals.length === 0) {
      console.log('[Scheduler] â„¹ï¸  Unique AL sinyali bulunamadÄ±');
      return;
    }

    // PREMIUM TELEGRAM MESAJI OLUÅTUR
    let message = 'â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n';
    message += 'â•‘ ğŸ’ PREMIUM TRADE SIGNALS ğŸ’ â•‘\n';
    message += 'â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£\n';
    message += `â•‘ ğŸ“… ${new Date().toLocaleString('tr-TR', {
      day: '2-digit',
      month: 'short',
      hour: '2-digit',
      minute: '2-digit'
    })}\n`;
    message += 'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';

    uniqueSignals.forEach((signal, index) => {
      const medal = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'][index] || `${index + 1}ï¸âƒ£`;
      const strategyIcon = {
        'AI': 'ğŸ¤–',
        'Quantum': 'âš›ï¸',
        'Conservative': 'ğŸ›¡ï¸',
        'Breakout': 'ğŸ’¥',
        'Omnipotent': 'ğŸ¯',
        'Nirvana': 'ğŸŒŸ'
      }[signal.strategy] || 'ğŸ“Š';

      message += `${medal} <b>${signal.symbol}</b>\n`;
      message += `${strategyIcon} ${signal.strategy}`;
      if (signal.strategyName) {
        message += ` (${signal.strategyName})`;
      }
      message += `\n`;

      message += `ğŸ“Š GÃ¼ven: ${signal.confidence}%\n`;

      if (signal.price && typeof signal.price === 'number') {
        message += `ğŸ’° GiriÅŸ: $${signal.price.toFixed(signal.price < 1 ? 6 : 2)}\n`;

        if (signal.targetPrice) {
          message += `ğŸ¯ Hedef: $${signal.targetPrice.toFixed(signal.targetPrice < 1 ? 6 : 2)} (+${((signal.targetPrice/signal.price - 1) * 100).toFixed(1)}%)\n`;
        }

        if (signal.stopLoss) {
          message += `ğŸ›‘ Stop: $${signal.stopLoss.toFixed(signal.stopLoss < 1 ? 6 : 2)} (${((signal.stopLoss/signal.price - 1) * 100).toFixed(1)}%)\n`;
        }

        if (signal.riskReward) {
          message += `âš–ï¸ Risk/Reward: ${signal.riskReward}\n`;
        }
      } else if (signal.buySignalsCount) {
        message += `ğŸ“ˆ ${signal.buySignalsCount} aktif AL sinyali\n`;
      }

      if (signal.quantumScore) {
        message += `ğŸ”¬ Quantum: ${signal.quantumScore}/100\n`;
      }

      if (signal.wyckoffPhase) {
        message += `ğŸ“Š Faz: ${signal.wyckoffPhase}\n`;
      }

      if (signal.reason) {
        message += `ğŸ’¡ ${signal.reason}\n`;
      }

      message += '\n';
    });

    // DISCLAIMER
    message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
    message += 'ğŸ“Š <b>Toplam:</b> ' + allSignals.length + ' sinyal tarandÄ±\n';
    message += 'âœ¨ <b>SeÃ§ilen:</b> ' + uniqueSignals.length + ' sinyal\n';
    message += 'ğŸ¯ <b>Stratejiler:</b> 6 (AI, Quantum, Conservative, Breakout, Omnipotent, Nirvana)\n\n';
    message += 'âš ï¸ <b>UYARI:</b>\n';
    message += 'â€¢ GiriÅŸ-Ã§Ä±kÄ±ÅŸ fiyatlarÄ± ve risk yÃ¶netimi kiÅŸiseldir\n';
    message += 'â€¢ YatÄ±rÄ±m kararlarÄ± size aittir\n';
    message += 'â€¢ AnlÄ±k piyasa koÅŸullarÄ±nÄ± takip edin\n';
    message += 'â€¢ Stop-loss kullanmayÄ± unutmayÄ±n\n\n';
    message += 'ğŸ’¼ Bu bilgiler yalnÄ±zca bilgilendirme amaÃ§lÄ±dÄ±r.';

    // Message validation - boÅŸ mesaj gÃ¶nderme!
    if (!message || message.trim().length === 0) {
      console.log('[Scheduler] âš ï¸  Mesaj iÃ§eriÄŸi boÅŸ, gÃ¶nderilmiyor');
      return;
    }

    await sendTelegramMessage(message);
    console.log(`[Scheduler] âœ… ${uniqueSignals.length} PREMIUM AL sinyali gÃ¶nderildi (6 strateji tarandÄ±)`);

  } catch (error) {
    console.error('[Scheduler] âŒ Top Buy Signals hatasÄ±:', error.message);
  }
}

// âš¡ GLOBAL MARKET CRITICAL EVENTS SCANNER (Multi-Timeframe Analysis)
async function sendCriticalMarketEvents() {
  try {
    console.log('\n[Scheduler] ğŸŒ GLOBAL MARKET CRITICAL EVENTS taranÄ±yor...');

    // 1. Binance futures verilerini Ã§ek (tÃ¼m coinler 24h deÄŸiÅŸim ile)
    const futuresData = await httpGet(`${BASE_URL}/api/binance/futures`).catch(() => ({ data: { all: [] } }));

    if (!futuresData.data?.all || futuresData.data.all.length === 0) {
      console.log('[Scheduler] âš ï¸  Binance futures data alÄ±namadÄ±');
      return;
    }

    const criticalEvents = [];

    // 2. HER COIN iÃ§in kritik olaylarÄ± tespit et
    futuresData.data.all.forEach(coin => {
      const symbol = coin.symbol;
      const price = parseFloat(coin.price);
      const change24h = parseFloat(coin.changePercent24h);
      const volume24h = parseFloat(coin.volume24h);
      const highPrice24h = parseFloat(coin.highPrice24h);
      const lowPrice24h = parseFloat(coin.lowPrice24h);

      // KRÄ°TÄ°K OLAY 1: BÃ¼yÃ¼k fiyat hareketleri (Â±8% Ã¼zeri)
      if (Math.abs(change24h) >= 8) {
        const importance = Math.abs(change24h) >= 15 ? 'CRITICAL' : 'HIGH';
        criticalEvents.push({
          type: change24h > 0 ? 'STRONG_PUMP' : 'STRONG_DUMP',
          symbol,
          importance,
          score: Math.abs(change24h),
          data: {
            price,
            change24h,
            volume24h,
            reason: change24h > 0 ? `GÃ¼Ã§lÃ¼ yÃ¼kseliÅŸ (+${change24h.toFixed(1)}%)` : `GÃ¼Ã§lÃ¼ dÃ¼ÅŸÃ¼ÅŸ (${change24h.toFixed(1)}%)`
          }
        });
      }

      // KRÄ°TÄ°K OLAY 2: ATH/ATL yakÄ±nlÄ±ÄŸÄ±
      const nearATH = ((price - highPrice24h) / highPrice24h) * 100;
      const nearATL = ((price - lowPrice24h) / lowPrice24h) * 100;

      if (nearATH >= -2 && nearATH <= 0) {
        criticalEvents.push({
          type: 'NEAR_ATH',
          symbol,
          importance: 'HIGH',
          score: 90 + nearATH * 5, // YaklaÅŸtÄ±kÃ§a skor artar
          data: {
            price,
            change24h,
            highPrice24h,
            reason: `24h zirvesine Ã§ok yakÄ±n (${Math.abs(nearATH).toFixed(2)}% altÄ±nda)`
          }
        });
      }

      if (Math.abs(nearATL) <= 2 && nearATL >= 0) {
        criticalEvents.push({
          type: 'NEAR_ATL',
          symbol,
          importance: 'HIGH',
          score: 90 - nearATL * 5,
          data: {
            price,
            change24h,
            lowPrice24h,
            reason: `24h dipine Ã§ok yakÄ±n (${nearATL.toFixed(2)}% Ã¼stÃ¼nde)`
          }
        });
      }

      // KRÄ°TÄ°K OLAY 3: YÃ¼ksek volume (top 50)
      // Not: Volume sÄ±ralamasÄ± yapÄ±lacak
    });

    // 3. Stratejilerden kritik sinyalleri ekle
    const [quantumData, omnipotentData, nirvanaData] = await Promise.all([
      httpGet(`${BASE_URL}/api/quantum-signals?limit=10`).catch(() => ({ data: { signals: [] } })),
      httpGet(`${BASE_URL}/api/omnipotent-futures?limit=10`).catch(() => ({ data: { futures: [] } })),
      httpGet(`${BASE_URL}/api/nirvana`).catch(() => ({ data: { strategies: [] } }))
    ]);

    // Quantum sinyalleri - %95+ confidence kritik
    if (quantumData.data?.signals) {
      quantumData.data.signals.forEach(s => {
        if (s.confidence >= 95 && s.type === 'BUY') {
          criticalEvents.push({
            type: 'QUANTUM_SIGNAL',
            symbol: s.symbol,
            importance: 'CRITICAL',
            score: s.confidence + (s.quantumScore || 0) / 10,
            data: {
              price: s.price,
              confidence: s.confidence,
              quantumScore: s.quantumScore,
              reason: `Ultra yÃ¼ksek gÃ¼ven Quantum sinyali (%${s.confidence})`
            }
          });
        }
      });
    }

    // Omnipotent - ACCUMULATION fazÄ± kritik
    if (omnipotentData.data?.futures) {
      omnipotentData.data.futures.forEach(s => {
        if (s.wyckoffPhase === 'ACCUMULATION' && s.confidence >= 80) {
          criticalEvents.push({
            type: 'WYCKOFF_ACCUMULATION',
            symbol: s.symbol,
            importance: 'HIGH',
            score: 85 + s.confidence / 10,
            data: {
              price: s.price,
              phase: s.wyckoffPhase,
              confidence: s.confidence,
              reason: 'Wyckoff ACCUMULATION fazÄ± - BÃ¼yÃ¼k fÄ±rsat'
            }
          });
        }
      });
    }

    // Nirvana - Multi-strateji consensus
    if (nirvanaData.data?.strategies) {
      const strongConsensus = nirvanaData.data.strategies
        .filter(st => st.status === 'active' && st.buySignals >= 5 && st.avgConfidence >= 85);

      strongConsensus.forEach(st => {
        criticalEvents.push({
          type: 'MULTI_STRATEGY_CONSENSUS',
          symbol: 'MULTI',
          importance: 'HIGH',
          score: 85 + st.buySignals,
          data: {
            strategyName: st.name.substring(0, 30),
            buySignals: st.buySignals,
            confidence: st.avgConfidence,
            reason: `${st.buySignals} strateji aynÄ± fikirde (%${st.avgConfidence.toFixed(0)})`
          }
        });
      });
    }

    // 4. Ã–NEM SIRASINA GÃ–RE SIRALA
    criticalEvents.sort((a, b) => b.score - a.score);

    if (criticalEvents.length === 0) {
      console.log('[Scheduler] â„¹ï¸  Kritik market olayÄ± tespit edilmedi');
      return;
    }

    // 5. EN Ã–NEMLÄ° 7 OLAYI SEÃ‡
    const topEvents = criticalEvents.slice(0, 7);

    // 6. TELEGRAM MESAJI OLUÅTUR
    let message = 'â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n';
    message += 'â•‘ ğŸŒ GLOBAL MARKET CRITICAL EVENTS â•‘\n';
    message += 'â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£\n';
    message += `â•‘ ğŸ“… ${new Date().toLocaleString('tr-TR', {
      day: '2-digit',
      month: 'short',
      hour: '2-digit',
      minute: '2-digit'
    })}\n`;
    message += 'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';

    const typeIcons = {
      'STRONG_PUMP': 'ğŸš€',
      'STRONG_DUMP': 'â¬‡ï¸',
      'NEAR_ATH': 'ğŸ”¥',
      'NEAR_ATL': 'â„ï¸',
      'QUANTUM_SIGNAL': 'âš›ï¸',
      'WYCKOFF_ACCUMULATION': 'ğŸ¯',
      'MULTI_STRATEGY_CONSENSUS': 'ğŸŒŸ'
    };

    const importanceColors = {
      'CRITICAL': 'ğŸ”´',
      'HIGH': 'ğŸŸ ',
      'MEDIUM': 'ğŸŸ¡'
    };

    topEvents.forEach((event, index) => {
      const icon = typeIcons[event.type] || 'ğŸ“Š';
      const impIcon = importanceColors[event.importance] || 'âšª';
      const medal = ['1ï¸âƒ£', '2ï¸âƒ£', '3ï¸âƒ£', '4ï¸âƒ£', '5ï¸âƒ£', '6ï¸âƒ£', '7ï¸âƒ£'][index];

      message += `${medal} ${icon} <b>${event.symbol}</b>\n`;
      message += `${impIcon} ${event.importance} (Score: ${event.score.toFixed(0)})\n`;

      if (event.data.price) {
        message += `ğŸ’° Price: $${typeof event.data.price === 'number' ? event.data.price.toFixed(event.data.price < 1 ? 6 : 2) : event.data.price}\n`;
      }

      if (event.data.change24h !== undefined) {
        const changeEmoji = event.data.change24h > 0 ? 'ğŸ“ˆ' : 'ğŸ“‰';
        message += `${changeEmoji} 24h: ${event.data.change24h > 0 ? '+' : ''}${event.data.change24h.toFixed(2)}%\n`;
      }

      if (event.data.confidence) {
        message += `ğŸ“Š Confidence: ${event.data.confidence}%\n`;
      }

      if (event.data.quantumScore) {
        message += `ğŸ”¬ Quantum: ${event.data.quantumScore}/100\n`;
      }

      if (event.data.buySignals) {
        message += `ğŸ“ˆ Buy Signals: ${event.data.buySignals}\n`;
      }

      message += `ğŸ’¡ ${event.data.reason}\n\n`;
    });

    // Ã–ZET
    message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
    message += `ğŸ“Š <b>Toplam:</b> ${criticalEvents.length} kritik olay tespit edildi\n`;
    message += `â­ <b>GÃ¶sterilen:</b> Top ${topEvents.length}\n`;
    message += `ğŸ¯ <b>Tarama:</b> Global market + 6 strateji\n`;
    message += `â° <b>SÄ±klÄ±k:</b> Her 30 dakikada\n\n`;
    message += 'âš ï¸ <b>NOT:</b> YÃ¼ksek Ã¶nem dereceli sinyaller\n';
    message += 'ğŸ’¼ HÄ±zlÄ± karar vermeniz gerekebilir';

    if (!message || message.trim().length === 0) {
      console.log('[Scheduler] âš ï¸  Mesaj iÃ§eriÄŸi boÅŸ');
      return;
    }

    await sendTelegramMessage(message);
    console.log(`[Scheduler] âœ… ${topEvents.length} CRITICAL MARKET EVENT gÃ¶nderildi`);

  } catch (error) {
    console.error('[Scheduler] âŒ Critical Market Events hatasÄ±:', error.message);
  }
}

// ğŸ“Š SAATLÄ°K BTC-ETH HIZLI ANALÄ°Z (Her saat baÅŸÄ±)
async function sendHourlyBTCETHAnalysis() {
  try {
    console.log('\n[Scheduler] ğŸ” Saatlik BTC-ETH Analizi hazÄ±rlanÄ±yor...');

    // Binance'den BTC ve ETH verilerini Ã§ek
    const [btcData, ethData] = await Promise.all([
      fetch('https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=BTCUSDT').then(r => r.json()),
      fetch('https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=ETHUSDT').then(r => r.json())
    ]);

    const btcPrice = parseFloat(btcData.lastPrice);
    const btcChange = parseFloat(btcData.priceChangePercent);
    const ethPrice = parseFloat(ethData.lastPrice);
    const ethChange = parseFloat(ethData.priceChangePercent);

    // Trend analizi
    const getTrend = (change) => {
      if (change > 1) return { emoji: 'â†—ï¸', text: 'GÃ¼Ã§lÃ¼ YÃ¼kseliÅŸ' };
      if (change > 0.3) return { emoji: 'â†—ï¸', text: 'Hafif YÃ¼kseliÅŸ' };
      if (change < -1) return { emoji: 'â†˜ï¸', text: 'GÃ¼Ã§lÃ¼ DÃ¼ÅŸÃ¼ÅŸ' };
      if (change < -0.3) return { emoji: 'â†˜ï¸', text: 'Hafif DÃ¼ÅŸÃ¼ÅŸ' };
      return { emoji: 'â¡ï¸', text: 'Yatay' };
    };

    const getMomentum = (change) => {
      const absChange = Math.abs(change);
      if (absChange > 2) return 'Ã‡ok GÃ¼Ã§lÃ¼';
      if (absChange > 1) return 'GÃ¼Ã§lÃ¼';
      if (absChange > 0.5) return 'Orta';
      return 'ZayÄ±f';
    };

    const btcTrend = getTrend(btcChange);
    const ethTrend = getTrend(ethChange);
    const btcMomentum = getMomentum(btcChange);
    const ethMomentum = getMomentum(ethChange);

    // Ã–zet yorum
    let summary = '';
    if (btcChange > 1 && ethChange > 1) {
      summary = 'BTC ve ETH gÃ¼Ã§lÃ¼ yÃ¼kseliÅŸte. Genel piyasa pozitif.';
    } else if (btcChange < -1 && ethChange < -1) {
      summary = 'BTC ve ETH gÃ¼Ã§lÃ¼ dÃ¼ÅŸÃ¼ÅŸte. Genel piyasa negatif.';
    } else if (btcChange > 1) {
      summary = 'BTC gÃ¼Ã§lÃ¼ yÃ¼kseliÅŸte, ETH daha yavaÅŸ. BTC dominansÄ± artÄ±yor.';
    } else if (ethChange > 1) {
      summary = 'ETH gÃ¼Ã§lÃ¼ yÃ¼kseliÅŸte, BTC daha yavaÅŸ. Altcoin momentum var.';
    } else {
      summary = 'BTC ve ETH yatay seyrediyor. Piyasa dengeli.';
    }

    const now = new Date();
    const dateStr = now.toLocaleDateString('tr-TR', { day: '2-digit', month: 'short', year: 'numeric' });
    const timeStr = now.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit', hour12: false });

    let message = 'â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n';
    message += 'â•‘  â° SAATLÄ°K PÄ°YASA RAPORU  â•‘\n';
    message += 'â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£\n';
    message += `â•‘  ğŸ“… ${dateStr} - ${timeStr} UTC\n`;
    message += 'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';

    message += 'ğŸ”¶ <b>BITCOIN (BTC)</b>\n';
    message += `ğŸ’° Fiyat: <b>$${btcPrice.toLocaleString('en-US')}</b>\n`;
    message += `ğŸ“Š 1 Saatlik: ${btcChange >= 0 ? '+' : ''}${btcChange.toFixed(2)}% ${btcTrend.emoji}\n`;
    message += `ğŸ“ˆ Trend: ${btcTrend.text}\n`;
    message += `âš¡ Momentum: ${btcMomentum}\n\n`;

    message += 'ğŸ”· <b>ETHEREUM (ETH)</b>\n';
    message += `ğŸ’° Fiyat: <b>$${ethPrice.toLocaleString('en-US')}</b>\n`;
    message += `ğŸ“Š 1 Saatlik: ${ethChange >= 0 ? '+' : ''}${ethChange.toFixed(2)}% ${ethTrend.emoji}\n`;
    message += `ğŸ“ˆ Trend: ${ethTrend.text}\n`;
    message += `âš¡ Momentum: ${ethMomentum}\n\n`;

    message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';
    message += 'ğŸ’¡ <b>Ã–ZET</b>\n';
    message += `${summary}\n\n`;

    message += 'âš ï¸ <i>Bu bilgiler yalnÄ±zca bilgilendirme amaÃ§lÄ±dÄ±r.</i>';

    await sendTelegramMessage(message);
    console.log('[Scheduler] âœ… Saatlik BTC-ETH analizi gÃ¶nderildi');

  } catch (error) {
    console.error('[Scheduler] âŒ Saatlik BTC-ETH analizi hatasÄ±:', error.message);
  }
}

// ğŸ“ˆ 4 SAATLÄ°K DETAYLI MARKET RAPORU (00:00, 04:00, 08:00, 12:00, 16:00, 20:00 UTC)
async function send4HourlyMarketReport() {
  try {
    console.log('\n[Scheduler] ğŸ“Š 4 Saatlik DetaylÄ± Market Raporu hazÄ±rlanÄ±yor...');

    // TÃ¼m verileri paralel olarak Ã§ek
    const [btcData, ethData, globalData, topAltcoins] = await Promise.all([
      fetch('https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=BTCUSDT').then(r => r.json()),
      fetch('https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=ETHUSDT').then(r => r.json()),
      fetch('https://api.coingecko.com/api/v3/global').then(r => r.json()),
      fetch('https://fapi.binance.com/fapi/v1/ticker/24hr').then(r => r.json())
    ]);

    // BTC Analizi
    const btcPrice = parseFloat(btcData.lastPrice);
    const btcChange24h = parseFloat(btcData.priceChangePercent);
    const btcHigh = parseFloat(btcData.highPrice);
    const btcLow = parseFloat(btcData.lowPrice);

    // ETH Analizi
    const ethPrice = parseFloat(ethData.lastPrice);
    const ethChange24h = parseFloat(ethData.priceChangePercent);
    const ethHigh = parseFloat(ethData.highPrice);
    const ethLow = parseFloat(ethData.lowPrice);

    // Market Cap verileri
    const totalMarketCap = globalData.data.total_market_cap.usd;
    const btcDominance = globalData.data.market_cap_percentage.btc;
    const ethDominance = globalData.data.market_cap_percentage.eth;

    // Top 10 altcoin ortalama deÄŸiÅŸimi (BTC ve ETH hariÃ§)
    const top10Altcoins = topAltcoins
      .filter(coin => !['BTCUSDT', 'ETHUSDT', 'USDTUSDT', 'BUSDUSDT'].includes(coin.symbol))
      .sort((a, b) => parseFloat(b.quoteVolume) - parseFloat(a.quoteVolume))
      .slice(0, 10);

    const altcoinAvgChange = top10Altcoins.reduce((sum, coin) => sum + parseFloat(coin.priceChangePercent), 0) / top10Altcoins.length;

    // Altcoin GÃ¼ven Endeksi Hesaplama
    const altcoinConfidenceIndex = Math.min(100, Math.max(0,
      (100 - btcDominance) * 0.6 +
      ethDominance * 0.4 +
      (altcoinAvgChange > 0 ? altcoinAvgChange : 0) * 0.3
    ));

    // Trend ve analiz fonksiyonlarÄ±
    const getTrendAnalysis = (change) => {
      if (change > 3) return { emoji: 'ğŸš€', text: 'GÃ¼Ã§lÃ¼ YÃ¼kseliÅŸ', color: 'green' };
      if (change > 1) return { emoji: 'â†—ï¸', text: 'Orta YÃ¼kseliÅŸ', color: 'lightgreen' };
      if (change < -3) return { emoji: 'ğŸ“‰', text: 'GÃ¼Ã§lÃ¼ DÃ¼ÅŸÃ¼ÅŸ', color: 'red' };
      if (change < -1) return { emoji: 'â†˜ï¸', text: 'Orta DÃ¼ÅŸÃ¼ÅŸ', color: 'orange' };
      return { emoji: 'â¡ï¸', text: 'Yatay', color: 'gray' };
    };

    // RSI tahmini (basitleÅŸtirilmiÅŸ)
    const estimateRSI = (change24h) => {
      const rsi = 50 + (change24h * 2);
      return Math.min(100, Math.max(0, rsi));
    };

    const btcRSI = estimateRSI(btcChange24h);
    const ethRSI = estimateRSI(ethChange24h);

    const getRSIStatus = (rsi) => {
      if (rsi > 70) return 'AÅŸÄ±rÄ± AlÄ±m';
      if (rsi > 60) return 'NÃ¶tr-AÅŸÄ±rÄ± AlÄ±m YakÄ±n';
      if (rsi < 30) return 'AÅŸÄ±rÄ± SatÄ±m';
      if (rsi < 40) return 'NÃ¶tr-AÅŸÄ±rÄ± SatÄ±m YakÄ±n';
      return 'NÃ¶tr';
    };

    const btcTrend = getTrendAnalysis(btcChange24h);
    const ethTrend = getTrendAnalysis(ethChange24h);

    // Destek-DirenÃ§ seviyeleri (basitleÅŸtirilmiÅŸ)
    const btcSupport = (btcLow * 1.002).toFixed(0);
    const btcResistance = (btcHigh * 0.998).toFixed(0);
    const ethSupport = (ethLow * 1.002).toFixed(2);
    const ethResistance = (ethHigh * 0.998).toFixed(2);

    // BTC-ETH korelasyon tahmini
    const correlation = Math.abs(btcChange24h - ethChange24h) < 2 ? 0.85 : 0.65;

    // Altcoin endeks durumu
    const getAltcoinStatus = (index) => {
      if (index > 70) return { emoji: 'ğŸš€', text: 'YÃœKSEK', desc: 'GÃ¼Ã§lÃ¼ altcoin momentum' };
      if (index > 50) return { emoji: 'ğŸ“ˆ', text: 'ORTA-YÃœKSEK', desc: 'Altcoin piyasasÄ± gÃ¼Ã§leniyor' };
      if (index > 30) return { emoji: 'â¡ï¸', text: 'ORTA', desc: 'Dengeli piyasa' };
      return { emoji: 'ğŸ“‰', text: 'DÃœÅÃœK', desc: 'BTC dominansÄ± yÃ¼ksek' };
    };

    const altcoinStatus = getAltcoinStatus(altcoinConfidenceIndex);

    const now = new Date();
    const dateStr = now.toLocaleDateString('tr-TR', { day: '2-digit', month: 'short', year: 'numeric' });
    const timeStr = now.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit', hour12: false });

    let message = 'â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n';
    message += 'â•‘  ğŸ“Š 4 SAATLÄ°K PÄ°YASA ANALÄ°ZÄ°  â•‘\n';
    message += 'â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£\n';
    message += `â•‘  ğŸ“… ${dateStr} - ${timeStr} UTC\n`;
    message += 'â•‘  â° 4h KapanÄ±ÅŸ Raporu\n';
    message += 'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';

    message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';
    message += 'ğŸ”¶ <b>BITCOIN ANALÄ°ZÄ°</b>\n\n';
    message += `ğŸ’° Fiyat: <b>$${btcPrice.toLocaleString('en-US')}</b>\n`;
    message += `ğŸ“ˆ 24 Saatlik: ${btcChange24h >= 0 ? '+' : ''}${btcChange24h.toFixed(2)}% ${btcTrend.emoji}\n\n`;
    message += `ğŸ¯ Trend: <b>${btcTrend.text}</b>\n`;
    message += `ğŸ“ Destek: $${btcSupport}\n`;
    message += `ğŸ“ DirenÃ§: $${btcResistance}\n\n`;
    message += `ğŸ“‰ RSI (24h): ${btcRSI.toFixed(0)} (${getRSIStatus(btcRSI)})\n`;
    message += `ğŸ“Š MACD: ${btcChange24h > 0 ? 'Pozitif KesiÅŸim âœ…' : 'Negatif âš ï¸'}\n\n`;
    message += `ğŸ’¡ <i>Yorum: BTC ${btcTrend.text.toLowerCase()} trendinde,`;
    message += ` $${btcResistance} direncini ${btcChange24h > 0 ? 'test ediyor' : 'izliyor'}.</i>\n\n`;

    message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';
    message += 'ğŸ”· <b>ETHEREUM ANALÄ°ZÄ°</b>\n\n';
    message += `ğŸ’° Fiyat: <b>$${ethPrice.toLocaleString('en-US')}</b>\n`;
    message += `ğŸ“ˆ 24 Saatlik: ${ethChange24h >= 0 ? '+' : ''}${ethChange24h.toFixed(2)}% ${ethTrend.emoji}\n\n`;
    message += `ğŸ¯ Trend: <b>${ethTrend.text}</b>\n`;
    message += `ğŸ“ Destek: $${ethSupport}\n`;
    message += `ğŸ“ DirenÃ§: $${ethResistance}\n\n`;
    message += `ğŸ“‰ RSI (24h): ${ethRSI.toFixed(0)} (${getRSIStatus(ethRSI)})\n`;
    message += `ğŸ“Š MACD: ${ethChange24h > 0 ? 'Pozitif âœ…' : 'Negatif âš ï¸'}\n\n`;
    message += `ğŸ”— BTC Korelasyon: ${correlation.toFixed(2)} (${correlation > 0.8 ? 'YÃ¼ksek' : 'Orta'})\n\n`;

    message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';
    message += 'ğŸŒ <b>GLOBAL PÄ°YASA</b>\n\n';
    message += `ğŸ’ Total Market Cap: <b>$${(totalMarketCap / 1e12).toFixed(2)}T</b>\n`;
    message += `ğŸ“ˆ 24h DeÄŸiÅŸim: ${((btcChange24h * btcDominance + ethChange24h * ethDominance) / 100).toFixed(2)}%\n\n`;
    message += `ğŸ”¶ BTC Dominance: ${btcDominance.toFixed(1)}%\n`;
    message += `ğŸ”· ETH Dominance: ${ethDominance.toFixed(1)}%\n\n`;

    message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';
    message += 'ğŸ¯ <b>ALTCOIN GÃœVEN ENDEKSÄ°</b>\n\n';
    message += `ğŸ“Š Skor: <b>${altcoinConfidenceIndex.toFixed(0)}/100</b> ${altcoinStatus.emoji}\n`;
    message += `ğŸ“ˆ Durum: <b>${altcoinStatus.text}</b>\n\n`;
    message += `ğŸ’¡ <b>AÃ§Ä±klama:</b>\n`;
    message += `${altcoinStatus.desc}. `;

    if (altcoinConfidenceIndex > 60) {
      message += `BTC dominance azalÄ±rken, ETH ve major altcoinler momentum kazanÄ±yor. Dikkatli altcoin pozisyonlarÄ± iÃ§in uygun ortam.`;
    } else if (altcoinConfidenceIndex < 40) {
      message += `BTC dominansÄ± yÃ¼ksek. Altcoin piyasasÄ± zayÄ±f, BTC odaklÄ± stratejiler Ã¶n planda.`;
    } else {
      message += `Piyasa dengeli. SeÃ§ici altcoin pozisyonlarÄ± deÄŸerlendirilebilir.`;
    }

    message += `\n\nTop 10 Altcoin Ort: ${altcoinAvgChange >= 0 ? '+' : ''}${altcoinAvgChange.toFixed(2)}%\n\n`;

    message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';
    message += 'âš ï¸ <b>UYARI</b>\n';
    message += 'â€¢ Bu bilgiler yalnÄ±zca bilgilendirme amaÃ§lÄ±dÄ±r\n';
    message += 'â€¢ YatÄ±rÄ±m kararlarÄ± kiÅŸiseldir\n';
    message += 'â€¢ Risk yÃ¶netimini unutmayÄ±n';

    await sendTelegramMessage(message);
    console.log('[Scheduler] âœ… 4 Saatlik detaylÄ± market raporu gÃ¶nderildi');

  } catch (error) {
    console.error('[Scheduler] âŒ 4 Saatlik market raporu hatasÄ±:', error.message);
  }
}

// âš¡ 15 DAKÄ°KALIK (Her 15 dakikada - En gÃ¼venilir AL sinyalleri)
cron.schedule('*/15 * * * *', async () => {
  const now = new Date().toLocaleString('tr-TR');
  console.log(`\nâ° [${now}] 15 DakikalÄ±k AL Sinyali Scheduler Tetiklendi`);
  await sendTopBuySignals();
});

// ğŸŒ 30 DAKÄ°KALIK (Her 30 dakikada - Kritik Piyasa OlaylarÄ±)
cron.schedule('*/30 * * * *', async () => {
  const now = new Date().toLocaleString('tr-TR');
  console.log(`\nâ° [${now}] 30 DakikalÄ±k Global Market Events Tetiklendi`);
  await sendCriticalMarketEvents();
});

// 1ï¸âƒ£ SAATLÄ°K (her saat baÅŸÄ± - BTC-ETH Analizi)
cron.schedule('0 * * * *', async () => {
  const now = new Date().toLocaleString('tr-TR');
  console.log(`\nâ° [${now}] 1 Saatlik BTC-ETH Analizi Tetiklendi`);
  await sendHourlyBTCETHAnalysis();
  await sendMarketCorrelation();
});

// 2ï¸âƒ£ 4 SAATLÄ°K (00:00, 04:00, 08:00, 12:00, 16:00, 20:00 UTC)
cron.schedule('0 */4 * * *', async () => {
  const now = new Date().toLocaleString('tr-TR');
  console.log(`\nâ° [${now}] 4 Saatlik DetaylÄ± Market Raporu Tetiklendi`);
  await send4HourlyMarketReport();
  await sendCryptoNews();
  await sendOmnipotentFutures();
  await sendBreakoutSignals();
});

// 3ï¸âƒ£ GÃœNLÃœK (UTC 00:00 = TÃ¼rkiye 03:00)
cron.schedule('0 0 * * *', async () => {
  const now = new Date().toLocaleString('tr-TR');
  console.log(`\nâ° [${now}] GÃ¼nlÃ¼k Scheduler Tetiklendi`);
  await sendNirvanaDaily();
  await sendBTCETHAnalysis();
});

// 4ï¸âƒ£ HAFTALIK (Pazartesi UTC 00:00)
cron.schedule('0 0 * * 1', async () => {
  const now = new Date().toLocaleString('tr-TR');
  console.log(`\nâ° [${now}] HaftalÄ±k Scheduler Tetiklendi`);
  await sendNirvanaDaily();
});

console.log('âœ… TÃ¼m Cron Job\'lar aktif edildi!');
console.log('\nğŸ“… Scheduler Takvimi:');
console.log('  - âš¡ 15 DakikalÄ±k: EN GÃœVENÄ°LÄ°R AL SÄ°NYALLERÄ° (Her 15 dakikada)');
console.log('  - ğŸŒ 30 DakikalÄ±k: GLOBAL CRITICAL MARKET EVENTS (Her 30 dakikada)');
console.log('  - ğŸ• Saatlik: BTC-ETH HIZLI ANALÄ°Z (Her saat baÅŸÄ±) â­NEW');
console.log('  - ğŸ•“ 4 Saatlik: DETAYLI MARKET RAPORU + Haberler (00:00, 04:00, 08:00, 12:00, 16:00, 20:00) â­NEW');
console.log('  - ğŸ“… GÃ¼nlÃ¼k: Nirvana + BTC-ETH (UTC 00:00 / TR 03:00)');
console.log('  - ğŸ“† HaftalÄ±k: Nirvana Ã¶zet (Pazartesi UTC 00:00)');
console.log('\nğŸ¯ YENÄ° Ã–ZELLÄ°KLER:');
console.log('   â€¢ Global market taramasÄ± ile kritik olaylar otomatik tespit edilir');
console.log('   â€¢ Saatlik BTC-ETH hÄ±zlÄ± analiz raporu');
console.log('   â€¢ 4 saatlik detaylÄ± market raporu (BTC, ETH, Market Cap, Altcoin GÃ¼ven Endeksi)');
console.log('â³ Scheduler Ã§alÄ±ÅŸÄ±yor... (Ctrl+C ile durdur)\n');

// Graceful shutdown
process.on('SIGINT', () => {
  console.log('\n\nğŸ›‘ Scheduler durduruluyor...');
  process.exit(0);
});

process.on('SIGTERM', () => {
  console.log('\n\nğŸ›‘ Scheduler PM2 tarafÄ±ndan durduruldu.');
  process.exit(0);
});
